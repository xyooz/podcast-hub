<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Podcast Hub</title>
    <link rel="icon" type="image/svg+xml" href="/static/cover.svg">
    <link rel="apple-touch-icon" href="/static/cover.svg">
    <style>
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 0 0 rgba(56, 189, 248, 0.4); } 50% { box-shadow: 0 0 20px 5px rgba(56, 189, 248, 0.2); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes modalSlideIn { from { opacity: 0; transform: scale(0.92) translateY(30px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        @keyframes listStagger { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        
        .animate-fade { animation: fadeIn 0.4s ease; }
        .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .animate-slide-down { animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .animate-scale { animation: scaleIn 0.2s ease; }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding-bottom: 100px;
            transition: background 0.3s, color 0.3s;
        }
        body.light-theme {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
            color: #1e293b;
        }
        body.light-theme .nav { background: rgba(248,250,252,0.95); }
        body.light-theme .nav-btn { background: rgba(255,255,255,0.5); border-color: rgba(0,0,0,0.1); color: #1e293b; }
        body.light-theme .card { background: rgba(255,255,255,0.8); color: #1e293b; }
        body.light-theme .modal-header { background: rgba(248,250,252,0.98); }
        body.light-theme .episode { background: rgba(255,255,255,0.7); color: #1e293b; }
        body.light-theme .add-box { background: rgba(248,250,252,0.8); }
        body.light-theme .input { background: rgba(255,255,255,0.9); border-color: rgba(0,0,0,0.2); color: #1e293b; }
        body.light-theme .btn-add { background: linear-gradient(135deg, #3b82f6, #8b5cf6); }
        body.light-theme .sort-btn { background: rgba(255,255,255,0.5); border-color: rgba(0,0,0,0.2); color: #1e293b; }
        body.light-theme .sort-btn.active { background: rgba(59,130,246,0.3); border-color: rgba(59,130,246,0.5); color: #1e293b; }
        body.light-theme .loading { color: #64748b; }
        body.light-theme .empty { color: #64748b; }
        body.light-theme .player { background: linear-gradient(90deg, #3b82f6, #8b5cf6, #c084fc); }
        body.light-theme .toast { background: rgba(248,250,252,0.95); color: #1e293b; }
        body.light-theme .player-btn, body.light-theme .speed-btn { background: rgba(255,255,255,0.3); }
        body.light-theme .player-progress { background: rgba(0,0,0,0.2); }
        body.light-theme .modal-btn.close { background: rgba(0,0,0,0.1); }
        body.light-theme .theme-btn { background: rgba(248,250,252,0.9); color: #1e293b; }
        .nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 12px 16px;
            display: flex;
            gap: 8px;
            overflow-x: auto;
            z-index: 100;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .nav-btn {
            padding: 10px 14px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: #94a3b8;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.12); color: #fff; }
        .nav-btn.active { background: rgba(56, 189, 248, 0.2); border-color: rgba(56, 189, 248, 0.4); color: #38bdf8; }
        .nav-btn:active { transform: scale(0.95); }
        .nav-btn:focus, .card:focus, .episode:focus, .btn-add:focus, button:focus {
            outline: 2px solid #38bdf8;
            outline-offset: 2px;
        }
        .main { padding: 80px 16px 20px; max-width: 600px; margin: 0 auto; }
        .add-box { background: rgba(30, 41, 59, 0.8); padding: 16px; border-radius: 12px; margin-bottom: 20px; }
        .add-box h2 { font-size: 16px; margin-bottom: 12px; }
        body.light-theme .add-box { background: rgba(248,250,252,0.8); }
        .search-result { padding: 8px; background: rgba(255,255,255,0.1); border-radius: 8px; margin-bottom: 8px; cursor: pointer; display: flex; align-items: center; gap: 12px; }
        .search-result:hover { background: rgba(255,255,255,0.2); }
        .search-result-img { width: 40px; height: 40px; border-radius: 6px; background: #334155; }
        .search-result-info { flex: 1; }
        .search-result-title { font-size: 14px; font-weight: 500; }
        .search-result-podcast { font-size: 12px; opacity: 0.7; }
        .input { width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; font-size: 14px; margin-bottom: 10px; }
        .btn-add { width: 100%; padding: 12px; background: linear-gradient(135deg, #0ea5e9, #8b5cf6); border: none; border-radius: 8px; color: #fff; font-size: 14px; cursor: pointer; }
        .btn-add:active { opacity: 0.8; }
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .card { 
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px; 
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeIn 0.4s ease;
            animation-fill-mode: both;
        }
        .card:nth-child(1) { animation-delay: 0.05s; }
        .card:nth-child(2) { animation-delay: 0.1s; }
        .card:nth-child(3) { animation-delay: 0.15s; }
        .card:nth-child(4) { animation-delay: 0.2s; }
        .card:nth-child(5) { animation-delay: 0.25s; }
        .card:nth-child(6) { animation-delay: 0.3s; }
        .card:hover { transform: translateY(-6px); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.35); border-color: rgba(56, 189, 248, 0.3); }
        .card:active { transform: scale(0.97); }
        .card-img { aspect-ratio: 1; position: relative; background: #1e293b; overflow: hidden; }
        .card-img img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s ease; }
        .card:hover .card-img img { transform: scale(1.08); }
        .card-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 50%); }
        .card-info { position: absolute; bottom: 12px; left: 12px; right: 12px; }
        .card-title { font-size: 14px; font-weight: 600; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .card-count { font-size: 12px; opacity: 0.7; margin-top: 4px; transition: opacity 0.2s ease; }
        .card:hover .card-count { opacity: 1; }
        .card-actions { display: flex; gap: 6px; padding: 10px; background: rgba(0,0,0,0.2); }
        .card-btn { flex: 1; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; font-size: 12px; text-align: center; cursor: pointer; transition: all 0.2s ease; }
        .card-btn:hover { background: rgba(56, 189, 248, 0.3); border-color: rgba(56, 189, 248, 0.5); }
        .card-btn:active { transform: scale(0.95); }
        .tab { display: none; }
        .tab.active { display: block; }
        
        /* ÂºπÁ™ó */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); z-index: 200; }
        .modal.show { display: flex; flex-direction: column; animation: modalSlideIn 0.35s cubic-bezier(0.34, 1.56, 0.64, 1); }        .modal-header { background: rgba(30, 41, 59, 0.98); padding: 16px; display: flex; gap: 14px; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); animation: slideDown 0.3s ease; }
        .modal-cover { width: 70px; height: 70px; border-radius: 16px; background: #334155; flex-shrink: 0; object-fit: cover; box-shadow: 0 8px 24px rgba(0,0,0,0.4); transition: transform 0.3s ease; }
        .modal-cover:hover { transform: scale(1.05); }
        .modal-info { flex: 1; min-width: 150px; }
        .modal-title { font-size: 17px; font-weight: 600; line-height: 1.3; }
        .modal-author { font-size: 13px; color: #94a3b8; margin-top: 6px; }
        .modal-count { font-size: 12px; color: #64748b; margin-top: 4px; }
        .modal-actions { display: flex; gap: 10px; margin-left: auto; }
        .modal-btn { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .modal-btn.refresh { background: rgba(56, 189, 248, 0.2); border: 1px solid rgba(56, 189, 248, 0.3); }
        .modal-btn.close { background: rgba(255,255,255,0.1); }
        .modal-btn:hover { transform: scale(1.08); box-shadow: 0 4px 12px rgba(56, 189, 248, 0.3); }
        .modal-btn:active { transform: scale(0.92); }
        
        /* ÊéíÂ∫èÂàáÊç¢ */
        .sort-bar { width: 100%; padding: 10px; display: flex; gap: 8px; justify-content: center; background: rgba(0,0,0,0.3); }
        .sort-btn { padding: 8px 20px; border-radius: 20px; font-size: 13px; cursor: pointer; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #94a3b8; transition: all 0.2s ease; }
        .sort-btn.active { background: rgba(56, 189, 248, 0.2); border-color: rgba(56, 189, 248, 0.4); color: #38bdf8; }
        .sort-btn:hover { background: rgba(255,255,255,0.15); }
        .sort-btn:active { transform: scale(0.95); }
        
        .modal-list { flex: 1; overflow-y: auto; padding: 12px; -webkit-overflow-scrolling: touch; max-height: calc(100vh - 200px); scrollbar-width: thin; scrollbar-color: rgba(56, 189, 248, 0.3) transparent; }
        .modal-list::-webkit-scrollbar { width: 6px; }
        .modal-list::-webkit-scrollbar-track { background: transparent; }
        .modal-list::-webkit-scrollbar-thumb { background: rgba(56, 189, 248, 0.3); border-radius: 3px; }
        .modal-list::-webkit-scrollbar-thumb:hover { background: rgba(56, 189, 248, 0.5); }
        .episode { background: rgba(30, 41, 59, 0.7); border-radius: 12px; padding: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1); border: 1px solid transparent; }
        .episode:hover { background: rgba(56, 189, 248, 0.15); border-color: rgba(56, 189, 248, 0.3); transform: translateX(4px); box-shadow: 0 4px 12px rgba(56, 189, 248, 0.2); }
        .episode:active { transform: scale(0.98); }
        .episode.playing { background: rgba(56, 189, 248, 0.2); border-color: rgba(56, 189, 248, 0.5); box-shadow: 0 0 20px rgba(56, 189, 248, 0.3); }
        .episode.playing .episode-title { color: #38bdf8; }
        .episode.playing::before { content: '‚ñ∂'; margin-right: 8px; color: #38bdf8; font-size: 12px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .episode-info { flex: 1; min-width: 0; }
        .episode-title { font-size: 14px; font-weight: 500; }
        .episode-meta { font-size: 12px; color: #94a3b8; margin-top: 4px; display: flex; gap: 12px; }
        .episode-date { color: #64748b; }
        .episode-desc { font-size: 12px; color: #94a3b8; margin-top: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        body.light-theme .episode-desc { color: #64748b; }
        .queue-btn { padding: 8px 14px; font-size: 12px; background: rgba(56, 189, 248, 0.1); border: 1px solid rgba(56, 189, 248, 0.2); border-radius: 20px; color: #38bdf8; font-weight: 500; transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .queue-btn:hover { background: rgba(56, 189, 248, 0.25); border-color: rgba(56, 189, 248, 0.5); transform: scale(1.05); box-shadow: 0 2px 8px rgba(56, 189, 248, 0.3); }
        .queue-btn:active { transform: scale(0.95); }
        .queue-list { 
            display: none;
        }
        .queue-popover {
            position: absolute;
            bottom: 55px;
            right: 8px;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(56, 189, 248, 0.2);
            border-radius: 16px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.4), 0 0 20px rgba(56, 189, 248, 0.15);
            padding: 8px;
            min-width: 280px;
            max-width: calc(100vw - 32px);
            max-height: 320px;
            overflow-y: auto;
            opacity: 0;
            transform: translateY(10px) scale(0.95);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 100;
            display: none;
        }
        .queue-popover.show {
            opacity: 1;
            transform: translateY(0) scale(1);
            display: block;
        }
        /* ÁßªÂä®Á´ØÈÄÇÈÖç */
        @media (max-width: 480px), (pointer: coarse) {
            .queue-popover {
                position: fixed;
                left: 10px;
                right: 10px;
                bottom: 90px;
                top: auto;
                max-height: 45vh;
                min-width: auto;
                border-radius: 16px;
                padding: 6px;
            }
        }
        .queue-popover::before {
            content: '';
            position: absolute;
            bottom: -10px;
            right: 28px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid rgba(15, 23, 42, 0.98);
        }
        .queue-popover-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
            user-select: none;
        }
        .queue-popover-item:hover {
            background: rgba(56, 189, 248, 0.15);
        }
        .queue-popover-item-playing {
            background: rgba(56, 189, 248, 0.3);
            border-left: 3px solid #38bdf8;
        }
        .queue-popover-item.dragging {
            opacity: 0.5;
            background: rgba(56, 189, 248, 0.2);
            transform: scale(0.98);
        }
        .queue-popover-item.drag-over {
            border-top: 2px solid #38bdf8;
            padding-top: 12px;
        }
        /* Êí≠ÊîæÂô® */
        .player { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: linear-gradient(90deg, #0ea5e9, #8b5cf6, #c084fc); padding: 12px 16px; z-index: 50; }
        .player.show { display: block; }
        .player-row { display: flex; align-items: center; gap: 12px; max-width: 600px; margin: 0 auto; }
        .player-cover { width: 48px; height: 48px; border-radius: 8px; background: #fff; }
        .player-info { flex: 1; min-width: 0; }
        .player-title { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .player-podcast { font-size: 12px; opacity: 0.7; }
        .player-btn { 
            width: 44px; 
            height: 44px; 
            background: rgba(255,255,255,0.2); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .player-btn:hover {
            transform: scale(1.08);
            background: rgba(255,255,255,0.3);
        }
        
        .player-btn:active {
            transform: scale(0.95);
        }
        
        #play-icon {
            font-size: 18px;
            display: block;
            transition: transform 0.15s ease;
        }
        .player-progress { 
            width: 100%; 
            height: 5px; 
            background: rgba(255,255,255,0.2); 
            cursor: pointer; 
            position: relative; 
            margin-top: 12px; 
            border-radius: 5px;
            overflow: hidden;
            transition: height 0.2s ease;
        }
        
        .player-progress:hover {
            height: 7px;
        }
        
        .player-progress-bar { 
            height: 100%; 
            background: linear-gradient(90deg, #0ea5e9, #8b5cf6);
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(14, 165, 233, 0.5);
            transition: width 0.1s linear;
            position: relative;
        }
        
        .player-progress-bar::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.2s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        
        .player-progress:hover .player-progress-bar::after {
            opacity: 1;
        }
        .player-time { font-size: 11px; color: rgba(255,255,255,0.7); margin-top: 4px; display: flex; justify-content: space-between; }
        .speed-btn { 
            padding: 4px 8px; 
            font-size: 11px; 
            background: rgba(255,255,255,0.2); 
            border-radius: 12px; 
            font-weight: 600;
            transition: all 0.2s ease;
            min-width: 42px;
            text-align: center;
            font-variant-numeric: tabular-nums;
        }
        
        .speed-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }
        
        .speed-btn:active {
            transform: scale(0.95);
        }
        
        .queue-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(56, 189, 248, 0.2);
            border-radius: 50%;
            color: #38bdf8;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid rgba(56, 189, 248, 0.3);
        }
        
        .queue-icon:hover {
            background: rgba(56, 189, 248, 0.3);
            transform: scale(1.08);
        }
        
        .queue-icon:active {
            transform: scale(0.92);
        }
        .theme-btn { position: fixed; top: 80px; right: 16px; width: 40px; height: 40px; background: rgba(30, 41, 59, 0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 150; font-size: 18px; transition: all 0.2s ease; animation: pulse-glow 3s ease-in-out infinite; }
        .theme-btn:hover { transform: scale(1.1); }
        body.light-theme .theme-btn { background: rgba(248,250,252,0.9); }
        
        .loading { text-align: center; padding: 40px; color: #94a3b8; }
        .loading::before { content: ''; display: inline-block; width: 24px; height: 24px; border: 2px solid rgba(56, 189, 248, 0.3); border-top-color: #0ea5e9; border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 8px; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty { text-align: center; padding: 60px 20px; color: #94a3b8; }
        .empty-icon { font-size: 48px; margin-bottom: 16px; animation: float 3s ease-in-out infinite; }
        
        .toast {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 14px 24px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 500;
            z-index: 300;
            display: none;
            align-items: center;
            gap: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .toast.show { display: flex; }
        .toast-icon { font-size: 16px; }
        
        /* Á°ÆËÆ§ÂºπÁ™ó */
        .confirm-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 300;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .confirm-overlay.show {
            display: flex;
            animation: fadeIn 0.2s ease;
        }
        
        .confirm-dialog {
            background: rgba(30, 41, 59, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 24px;
            max-width: 320px;
            width: 100%;
            text-align: center;
            animation: scaleIn 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .confirm-icon {
            font-size: 48px;
            margin-bottom: 16px;
            animation: float 3s ease-in-out infinite;
        }
        
        .confirm-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .confirm-message {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 24px;
            line-height: 1.5;
        }
        
        .confirm-btns {
            display: flex;
            gap: 12px;
        }
        
        .confirm-btn {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }
        
        .confirm-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
            color: #94a3b8;
        }
        
        .confirm-btn.cancel:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .confirm-btn.confirm {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: #fff;
        }
        
        .confirm-btn.confirm:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        
        .confirm-btn:active {
            transform: scale(0.98);
        }
        
        /* ÂéÜÂè≤ËÆ∞ÂΩïÊ†∑Âºè */
        .history-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.25s ease;
            border: 1px solid transparent;
            animation: slideUp 0.3s ease;
        }
        .history-item:hover {
            background: rgba(30, 41, 59, 0.9);
            border-color: rgba(56, 189, 248, 0.3);
            transform: translateX(4px);
        }
        .history-item:active {
            transform: scale(0.98);
        }
        .history-cover {
            width: 52px;
            height: 52px;
            border-radius: 10px;
            object-fit: cover;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .history-info {
            flex: 1;
            min-width: 0;
        }
        .history-title {
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .history-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
            font-size: 12px;
            color: #94a3b8;
        }
        .history-podcast {
            opacity: 0.8;
        }
        .history-time {
            opacity: 0.6;
            font-size: 11px;
        }
        .history-play {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(56, 189, 248, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #38bdf8;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.25s ease;
        }
        .history-item:hover .history-play {
            opacity: 1;
            transform: scale(1);
        }
        body.light-theme .history-item {
            background: rgba(248, 250, 252, 0.8);
        }
        /* ÊÇ¨ÊµÆÈòüÂàóÊ†∑Âºè */
        .queue-popover {
            position: absolute;
            bottom: 55px;
            right: 8px;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(56, 189, 248, 0.2);
            border-radius: 16px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.4), 0 0 20px rgba(56, 189, 248, 0.15);
            padding: 8px;
            min-width: 280px;
            max-width: calc(100vw - 32px);
            max-height: 320px;
            overflow-y: auto;
            opacity: 0;
            transform: translateY(10px) scale(0.95);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 100;
            display: none;
        }
        .queue-popover.show {
            opacity: 1;
            transform: translateY(0) scale(1);
            display: block;
        }
        /* ÁßªÂä®Á´ØÈÄÇÈÖç */
        @media (max-width: 480px), (pointer: coarse) {
            .queue-popover {
                position: fixed;
                left: 10px;
                right: 10px;
                bottom: 90px;
                top: auto;
                max-height: 45vh;
                min-width: auto;
                border-radius: 16px;
                padding: 6px;
            }
        }
        .queue-popover::before {
            content: '';
            position: absolute;
            bottom: -10px;
            right: 28px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid rgba(15, 23, 42, 0.98);
        }

    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <div style="text-align:center;padding:20px 16px 10px;animation:fadeIn 0.5s ease;">
        <h1 style="font-size:28px;font-weight:700;background:linear-gradient(135deg, #38bdf8 0%, #818cf8 50%, #c084fc 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">üéôÔ∏è Podcast Hub</h1>
    </div>
</head>
<body>
    <a href="#main-content" class="sr-only" style="position:absolute;left:-9999px;padding:8px;background:#0ea5e9;color:#fff;z-index:9999;transition:left 0.3s;" onfocus="this.style.left='0';" onblur="this.style.left='-9999px';">Ë∑≥Âà∞‰∏ªË¶ÅÂÜÖÂÆπ</a>
    <nav class="nav" aria-label="Main navigation">
        <button class="nav-btn active" onclick="showTab('discover')" aria-selected="true" tabindex="0">ÂèëÁé∞</button>
        <button class="nav-btn" onclick="showTab('podcasts')" aria-selected="false" tabindex="0">ËÆ¢ÈòÖ</button>
        <button class="nav-btn" onclick="showTab('favorites')" aria-selected="false" tabindex="0">Êî∂Ëóè</button>
        <button class="nav-btn" onclick="showTab('history')" aria-selected="false" tabindex="0">ÂéÜÂè≤</button>
        <button class="nav-btn" onclick="showTab('stats')" aria-selected="false" tabindex="0">ÁªüËÆ°</button>
    </nav>
    
    <div id="tab-discover" class="tab active">
        <div id="main-content" class="main" role="main">
            <div class="add-box">
                <h2>Ê∑ªÂä†Êí≠ÂÆ¢</h2>
                <input type="text" id="add-url" class="input" placeholder="Á≤òË¥¥Â∞èÂÆáÂÆôÂàÜ‰∫´ÈìæÊé•ÊàñRSSÂú∞ÂùÄ..." aria-label="Podcast URL">
                <button class="btn-add" onclick="addPodcast()">Ê∑ªÂä†Êí≠ÂÆ¢</button>
            </div>
            
            <div class="add-box" style="padding:12px;">
                <input type="text" id="search-input" class="input" style="margin-bottom:8px;" placeholder="ÊêúÁ¥¢Êí≠ÂÆ¢ÂíåËäÇÁõÆ..." aria-label="Search" oninput="searchPodcasts(this.value)">
                <div id="search-results"></div>
            </div>
            <div id="podcasts-grid" class="grid"></div>
        </div>
    </div>
    
    <div id="tab-podcasts" class="tab">
        <div class="main"><div id="subscribed-grid" class="grid"></div></div>
    </div>
    <div id="tab-favorites" class="tab">
        <div class="main"><div id="favorites-grid" class="grid"></div></div>
    </div>
    <div id="tab-history" class="tab">
        <div class="main"><div id="history-list"></div></div>
    </div>
    <div id="tab-stats" class="tab">
        <div class="main" id="stats-content"></div>
    </div>
    
    <div id="modal" class="modal">
        <div class="modal-header">
            <img id="modal-cover" class="modal-cover" src="" alt="Podcast cover">
            <div class="modal-info">
                <div id="modal-title" class="modal-title"></div>
                <div id="modal-author" class="modal-author"></div>
                <div id="modal-count" class="modal-count"></div>
            </div>
            <div class="modal-actions">
                <div class="modal-btn refresh" onclick="refreshEpisodes()" title="Âà∑Êñ∞">üîÑ</div>
                <button class="modal-btn close" onclick="closeModal()" aria-label="Close">‚úï</button>
            </div>
        </div>
        <div class="sort-bar">
            <button class="sort-btn active" id="sort-new" onclick="setSort('new')">üîΩ ÊúÄÊñ∞</button>
            <button class="sort-btn" id="sort-old" onclick="setSort('old')">üîº ÊúÄÊóß</button>
        </div>
        <div id="modal-list" class="modal-list"></div>
    </div>
    
    <div id="player" class="player">
        <div class="player-row">
            <img id="player-cover" src="/static/cover.svg" class="player-cover">
            <div class="player-info">
                <div id="player-title" class="player-title">ÁÇπÂáªÈÄâÊã©ËäÇÁõÆÊí≠Êîæ</div>
                <div id="player-podcast" class="player-podcast"></div>
                <div class="player-progress" onclick="seekPlayer(event)">
                    <div id="player-progress-bar" class="player-progress-bar" style="width:0%"></div>
                </div>
                <div class="player-time">
                    <span id="player-current-time">0:00</span>
                    <span id="player-duration">0:00</span>
                </div>
            </div>
            <div style="display:flex;align-items:center;gap:6px;">
                <span class="queue-icon" onclick="toggleQueuePopover()" title="Êí≠ÊîæÈòüÂàó">üìã</span>
                <button id="play-btn" class="player-btn" onclick="togglePlay()" aria-label="Play/Pause">
                    <span id="play-icon">‚ñ∂Ô∏è</span>
                </button>
                <button class="speed-btn" onclick="changeSpeed()">1.00x</button>
            </div>
        </div>
        <div id="queue-list" class="queue-list"></div>
    </div>
    
    <audio id="audio"></audio>
    <div id="toast" class="toast"><span class="toast-icon">‚úÖ</span><span id="toast-message"></span></div>
    
    <!-- Á°ÆËÆ§ÂºπÁ™ó -->
    <div id="confirm-overlay" class="confirm-overlay">
        <div class="confirm-dialog">
            <div id="confirm-icon" class="confirm-icon">‚ùì</div>
            <div id="confirm-title" class="confirm-title">Á°ÆËÆ§Êìç‰Ωú</div>
            <div id="confirm-message" class="confirm-message"></div>
            <div class="confirm-btns">
                <button id="confirm-cancel" class="confirm-btn cancel">ÂèñÊ∂à</button>
                <button id="confirm-ok" class="confirm-btn confirm">Á°ÆËÆ§</button>
            </div>
        </div>
    </div>
    <button class="theme-btn" onclick="toggleTheme()" aria-label="Toggle theme">üåô</button>
    
    <script>
        // Global error handler
        window.onerror = function(msg, url, line, col, error) {
            console.error('Error:', msg, 'at', url, ':' + line);
            return false;
        };
        
        // Abort controller for API calls
        const APIAbort = {
            controllers: new Map(),
            
            abort(key) {
                if (this.controllers.has(key)) {
                    this.controllers.get(key).abort();
                    this.controllers.delete(key);
                }
            },
            
            create(key) {
                this.abort(key);
                const ctrl = new AbortController();
                this.controllers.set(key, ctrl);
                return ctrl.signal;
            }
        };
        
        const API = '/api';
        let podcasts = [];
        let currentEpisodes = [];
        let currentPodcastId = null;
        let currentEpisodeId = null;
        let sortOrder = 'new'; // 'new' Êàñ 'old'
        let isPlaying = false;
        let progressTimer = null;
        let currentSpeed = 1;
        let playQueue = [];
        let queueIndex = 0;
        var audio = document.getElementById('audio');
        if (!audio) {
            console.error('Audio element not found!');
        }
        
        function showToast(msg, icon) {
            var toast = document.getElementById('toast');
            var toastMsg = document.getElementById('toast-message');
            var toastIcon = document.querySelector('.toast-icon');
            toastMsg.textContent = msg;
            if (toastIcon) toastIcon.textContent = icon || '‚úÖ';
            toast.classList.add('show');
            setTimeout(function() { toast.classList.remove('show'); }, 2500);
        }
        
        // Áé∞‰ª£Á°ÆËÆ§ÂºπÁ™ó
        var confirmCallback = null;
        
        function showConfirm(title, message, icon, callback) {
            var overlay = document.getElementById('confirm-overlay');
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            document.getElementById('confirm-icon').textContent = icon || '‚ùì';
            confirmCallback = callback;
            overlay.classList.add('show');
        }
        
        function hideConfirm() {
            document.getElementById('confirm-overlay').classList.remove('show');
            confirmCallback = null;
        }
        
        document.getElementById('confirm-cancel').onclick = function() {
            if (confirmCallback) confirmCallback(false);
            hideConfirm();
        };
        
        document.getElementById('confirm-ok').onclick = function() {
            if (confirmCallback) confirmCallback(true);
            hideConfirm();
        };
        
        // ÊõøÊç¢ÂéüÁîü confirm
        window.confirm = function(message) {
            return new Promise(function(resolve) {
                showConfirm('Á°ÆËÆ§Êìç‰Ωú', message, '‚ùì', function(result) {
                    resolve(result);
                });
            });
        };
        
        function showTab(tab) {
            var btns = document.querySelectorAll('.nav-btn');
            btns.forEach(function(b) { b.classList.remove('active'); });
            btns[tab === 'discover' ? 0 : tab === 'podcasts' ? 1 : tab === 'favorites' ? 2 : 3].classList.add('active');
            
            document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
            document.getElementById('tab-' + tab).classList.add('active');
            
            if (tab === 'podcasts') {
                loadPodcasts(false);  // ÂÖàÊòæÁ§∫ÁºìÂ≠ò
                refreshInBackground();  // ÂêéÂè∞Âà∑Êñ∞
            }
            else if (tab === 'favorites') loadFavorites();
            else if (tab === 'history') loadHistory();
            else if (tab === 'stats') loadStats();
        }
        
        function searchPodcasts(keyword) {
            var results = document.getElementById('search-results');
            if (!keyword || keyword.length < 2) {
                results.innerHTML = "";
                return;
            }
            
            keyword = keyword.toLowerCase();
            var results_html = "";
            
            // ÊêúÁ¥¢Êí≠ÂÆ¢ÔºàÊ†áÈ¢ò+ÊèèËø∞Ôºâ
            podcasts.forEach(function(p) {
                if ((p.title && p.title.toLowerCase().includes(keyword)) || 
                    (p.description && p.description.toLowerCase().includes(keyword))) {
                    results_html += '<div class="search-result" onclick="showEpisodes(' + p.id + ')">' +
                        '<img src="' + (p.image_url || '') + '" class="search-result-img" onerror="this.style.background=\'#334155\'">' +
                        '<div class="search-result-info"><div class="search-result-title">' + p.title + '</div>' +
                        '<div class="search-result-podcast">Êí≠ÂÆ¢ ¬∑ ' + (p.episode_count || 0) + ' ÈõÜ' + (p.category ? ' ¬∑ ' + p.category : '') + '</div></div></div>';
                }
            });
            
            // ÊêúÁ¥¢ËäÇÁõÆÔºàÊ†áÈ¢ò+ÊèèËø∞Ôºâ
            currentEpisodes.forEach(function(e) {
                if ((e.title && e.title.toLowerCase().includes(keyword)) || 
                    (e.description && e.description.toLowerCase().includes(keyword))) {
                    var podcast = podcasts.find(function(p) { return p.id === e.podcast_id; }) || {};
                    results_html += '<div class="search-result" onclick="playSearchedEpisode(' + e.podcast_id + ',' + e.id + ')">' +
                        '<img src="' + (podcast.image_url || '') + '" class="search-result-img" onerror="this.style.background=\'#334155\'">' +
                        '<div class="search-result-info"><div class="search-result-title">' + (e.title || 'Êú™Áü•ËäÇÁõÆ') + '</div>' +
                        '<div class="search-result-podcast">' + (podcast.title || '') + ' ¬∑ ' + (e.duration_str || '0:00') + '</div></div></div>';
                }
            });
            
            results.innerHTML = results_html || '<div style="padding:8px;color:#64748b;font-size:12px;">Êú™ÊâæÂà∞ÁªìÊûú</div>';
        }
        
        function playSearchedEpisode(podcastId, episodeId) {
            fetch(API + '/podcast/' + podcastId + '/episodes').then(function(r) { return r.json(); }).then(function(d) {
                var ep = d.data.find(function(e) { return e.id === episodeId; });
                if (ep) {
                    var podcast = podcasts.find(function(p) { return p.id === podcastId; }) || {};
                    document.getElementById('player').classList.add('show');
                    document.getElementById('player-cover').src = podcast.image_url || '';
                    document.getElementById('player-title').textContent = ep.title;
                    document.getElementById('player-podcast').textContent = podcast.title || '';
                    currentEpisodeId = ep.id;
                    audio.src = ep.audio_url;
                    audio.play();
                    isPlaying = true;
                    document.getElementById('search-input').value = '';
                    document.getElementById('search-results').innerHTML = '';
                }
            });
        }
        
        function loadPodcasts(refresh, callback) {
            var grid = document.getElementById('podcasts-grid');
            
            // Â¶ÇÊûúÊúâÁºìÂ≠ò‰∏î‰∏çÂº∫Âà∂Âà∑Êñ∞ÔºåÁõ¥Êé•‰ΩøÁî®ÁºìÂ≠òÊ∏≤Êüì
            if (!refresh && podcasts.length > 0) {
                renderPodcasts(podcasts, 'podcasts-grid');
                renderPodcasts(podcasts, 'subscribed-grid');
                if (callback) callback();
                return;
            }
            
            // Âº∫Âà∂Âà∑Êñ∞Êó∂ÊòæÁ§∫ loading
            if (refresh) {
                grid.innerHTML = '<div class="loading">üîÑ Âà∑Êñ∞‰∏≠...</div>';
            }
            
            fetch(API + '/podcast').then(function(r) { return r.json(); }).then(function(d) {
                if (d.success) {
                    podcasts = d.data;
                    renderPodcasts(podcasts, 'podcasts-grid');
                    renderPodcasts(podcasts, 'subscribed-grid');
                    if (callback) callback();
                }
            }).catch(function(e) {
                if (callback) callback();
            });
        }
        
        function refreshInBackground() {
            // ÂêéÂè∞ÈùôÈªòÂà∑Êñ∞ÊâÄÊúâÊí≠ÂÆ¢
            fetch(API + '/podcast').then(function(r) { return r.json(); }).then(function(d) {
                if (d.success && d.data) {
                    d.data.forEach(function(p) {
                        fetch(API + '/podcast/' + p.id + '/refresh', { 
                            method: 'POST',
                            cache: 'no-store'
                        }).catch(function(e) {
                            console.log('ÂêéÂè∞Âà∑Êñ∞Â§±Ë¥•: ' + p.title);
                        });
                    });
                }
            });
        }
        
        
        function renderPodcasts(list, containerId) {
            var container = document.getElementById(containerId);
            if (!container) return;
            if (list.length === 0) {
                container.innerHTML = '<div class="empty"><div class="empty-icon">üì≠</div><p>ÊöÇÊó†ÂÜÖÂÆπ</p></div>';
                return;
            }
            
            var isSubscribed = containerId === 'subscribed-grid';
            var isFavorites = containerId === 'favorites-grid';
            
            container.innerHTML = list.map(function(p) {
                var img = p.image_url || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><rect fill="%23334155" width="200" height="200"/><text x="100" y="100" text-anchor="middle" fill="%2394a3b8" font-size="60">üéôÔ∏è</text></svg>';
                var actions = '';
                if (isSubscribed) {
                    actions = '<div class="card-actions"><button class="card-btn" onclick="event.stopPropagation();deletePodcast(' + p.id + ')" aria-label="Delete">üóëÔ∏è</button><button class="card-btn" onclick="event.stopPropagation();addFavorite(' + p.id + ')" aria-label="Add to favorites">‚ù§Ô∏è</button></div>';
                } else if (isFavorites) {
                    actions = '<div class="card-actions"><button class="card-btn" onclick="event.stopPropagation();removeFavorite(' + p.id + ')">üíî</button></div>';
                } else {
                    actions = '<div class="card-actions"><button class="card-btn" onclick="event.stopPropagation();addFavorite(' + p.id + ')">‚ù§Ô∏è</button></div>';
                }
                return '<div class="card" onclick="showEpisodes(' + p.id + ')"><div class="card-img"><img src="' + img + '"><div class="card-overlay"></div><div class="card-info"><div class="card-title">' + p.title + '</div><div class="card-count">' + p.episode_count + ' ÈõÜ</div></div></div>' + actions + '</div>';
            }).join('');
        }

        function loadFavorites() {
            fetch(API + '/favorite').then(function(r) { return r.json(); }).then(function(d) {
                if (d.success) renderPodcasts(d.data, 'favorites-grid');
            });
        }
        
        function loadStats() {
            var container = document.getElementById('stats-content');
            container.innerHTML = '<div class="loading">Âä†ËΩΩ‰∏≠...</div>';
            
            fetch(API + '/stats').then(function(r) { return r.json(); }).then(function(d) {
                if (d.success) {
                    var s = d.data;
                    container.innerHTML = '<div class="add-box" style="max-width:500px;">' +
                        '<h2 style="display:flex;align-items:center;gap:8px;"><span style="font-size:24px;">üìä</span> Êí≠ÊîæÁªüËÆ°</h2>' +
                        '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:20px;">' +
                        '<div style="text-align:center;padding:20px;background:linear-gradient(135deg, rgba(56,189,248,0.2), rgba(139,92,246,0.2));border-radius:12px;border:1px solid rgba(56,189,248,0.3);">' +
                        '<div style="font-size:28px;font-weight:bold;background:linear-gradient(90deg,#38bdf8,#c084fc);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">' + s.total_plays + '</div>' +
                        '<div style="font-size:12px;opacity:0.8;margin-top:4px;">Êí≠ÊîæÊ¨°Êï∞</div></div>' +
                        '<div style="text-align:center;padding:20px;background:linear-gradient(135deg, rgba(34,197,94,0.2), rgba(59,130,246,0.2));border-radius:12px;border:1px solid rgba(34,197,94,0.3);">' +
                        '<div style="font-size:28px;font-weight:bold;background:linear-gradient(90deg,#22c55e,#3b82f6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">' + (s.total_duration_str || '0:00') + '</div>' +
                        '<div style="font-size:12px;opacity:0.8;margin-top:4px;">ÊÄªÊî∂Âê¨Êó∂Èïø</div></div></div>' +
                        '<h3 style="margin:24px 0 12px;font-size:14px;display:flex;align-items:center;gap:6px;"><span>üî•</span> ÁÉ≠Èó®Êí≠ÂÆ¢</h3>' +
                        '<div style="display:flex;flex-direction:column;gap:8px;">' +
                        (s.podcasts && s.podcasts.length > 0 ? s.podcasts.map(function(p, idx) {
                            return '<div style="padding:12px 16px;background:rgba(255,255,255,0.1);border-radius:8px;display:flex;justify-content:space-between;align-items:center;' + 
                                (idx === 0 ? 'border-left:3px solid #f59e0b;' : '') + '">' +
                                '<div style="display:flex;align-items:center;gap:10px;"><span style="font-size:14px;opacity:0.5;width:20px;">' + (idx + 1) + '</span><span>' + p.title + '</span></div>' +
                                '<span style="font-size:13px;padding:4px 10px;background:rgba(56,189,248,0.2);border-radius:12px;color:#38bdf8;">' + p.count + ' Ê¨°</span></div>';
                        }).join('') : '<div style="padding:20px;text-align:center;color:#64748b;">ÊöÇÊó†Êï∞ÊçÆ</div>') +
                        '</div>' +
                        '<h3 style="margin:24px 0 12px;font-size:14px;display:flex;align-items:center;gap:6px;"><span>üìÖ</span> ÊúÄËøëÊ¥ªÂä®</h3>' +
                        '<div id="stats-recent" style="padding:8px;"></div>' +
                        '</div>';
                    
                    // Âä†ËΩΩÊúÄËøëÂéÜÂè≤
                    fetch(API + '/history?limit=5').then(function(r) { return r.json(); }).then(function(h) {
                        if (h.success && h.data && h.data.length > 0) {
                            var recentHtml = h.data.map(function(item) {
                                return '<div style="padding:10px 12px;background:rgba(255,255,255,0.05);border-radius:8px;margin-bottom:6px;display:flex;align-items:center;gap:10px;">' +
                                    '<span style="font-size:16px;">‚ñ∂</span>' +
                                    '<div style="flex:1;min-width:0;"><div style="font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + (item.title || 'Êú™Áü•ËäÇÁõÆ') + '</div>' +
                                    '<div style="font-size:11px;opacity:0.6;">' + (item.podcast_title || '') + '</div></div>' +
                                    '<span style="font-size:11px;opacity:0.5;">' + (item.played_at ? new Date(item.played_at).toLocaleDateString('zh-CN') : '') + '</span></div>';
                            }).join('');
                            document.getElementById('stats-recent').innerHTML = recentHtml;
                        } else {
                            document.getElementById('stats-recent').innerHTML = '<div style="padding:12px;text-align:center;color:#64748b;font-size:12px;">ÊöÇÊó†ËÆ∞ÂΩï</div>';
                        }
                    });
                } else {
                    container.innerHTML = '<div class="empty">Âä†ËΩΩÂ§±Ë¥•</div>';
                }
            });
        }
        
        function loadHistory() {
            var container = document.getElementById('history-list');
            
            // Á°Æ‰øù podcasts Â∑≤Âä†ËΩΩ
            if (podcasts.length === 0) {
                loadPodcasts(true, function() { loadHistory(); });
                return;
            }
            
            container.innerHTML = '<div class="loading">Âä†ËΩΩ‰∏≠...</div>';
            
            fetch(API + '/history').then(function(r) { return r.json(); }).then(function(d) {
                if (d.data.length === 0) {
                    container.innerHTML = '<div class="empty"><div class="empty-icon">üïê</div><p>ÊöÇÊó†ËÆ∞ÂΩï</p></div>';
                    return;
                }
                
                // ÊûÑÂª∫ podcast ÁºìÂ≠ò
                var podcastCache = {};
                podcasts.forEach(function(p) { podcastCache[p.id] = p; });
                
                container.innerHTML = d.data.map(function(h) {
                    var time = h.played_at ? new Date(h.played_at).toLocaleString('zh-CN', {month:'numeric',day:'numeric',hour:'2-digit',minute:'2-digit'}) : '';
                    var podcast = podcastCache[h.podcast_id] || {};
                    return '<div class="history-item" onclick="playHistoryItem(' + h.episode_id + ',' + h.podcast_id + ')">' +
                        '<img src="' + (h.podcast_image || podcast.image_url || '') + '" onerror="this.style.background=\'#334155\'" class="history-cover">' +
                        '<div class="history-info"><div class="history-title">' + h.title + '</div>' +
                        '<div class="history-meta"><span class="history-podcast">' + (h.podcast_title || podcast.title || 'Êú™Áü•Êí≠ÂÆ¢') + '</span>' + 
                        (time ? '<span class="history-time">' + time + '</span>' : '') + 
                        '</div></div><div class="history-play">‚ñ∂</div></div>';
                }).join('');
            }).catch(function(e) {
                container.innerHTML = '<div class="empty">Âä†ËΩΩÂ§±Ë¥•</div>';
            });
        }
        
        function playHistoryItem(episodeId, podcastId) {
            fetch(API + '/play/' + episodeId, {method: 'POST'}).then(function(r) { return r.json(); })
                .then(function(d) {
                    if (d.success) {
                        document.getElementById('player').classList.add('show');
                        document.getElementById('player-cover').src = d.image_url || '/static/cover.svg';
                        document.getElementById('player-title').textContent = d.title;
                        document.getElementById('player-podcast').textContent = d.podcast_title;
                        audio.src = d.audio_url;
                        audio.play();
                        isPlaying = true;
                        savePlayerState();
                    }
                });
        }
        
        function getPodcastImage(id) {
            var p = podcasts.find(function(x) { return x.id === id; });
            return p ? p.image_url : null;
        }
        
        function addPodcast() {
            var url = document.getElementById('add-url').value.trim();
            if (!url) { showToast('ËØ∑ËæìÂÖ•ÈìæÊé•'); return; }
            
            var btn = document.querySelector('.btn-add');
            btn.textContent = 'Ê∑ªÂä†‰∏≠...';
            btn.disabled = true;
            
            fetch(API + '/podcast', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({url: url}) })
                .then(function(r) { return r.json(); })
                .then(function(d) {
                    if (d.success) {
                        showToast('Ê∑ªÂä†ÊàêÂäüÔºÅ');
                        document.getElementById('add-url').value = '';
                        loadPodcasts();
                    } else { showToast('Â§±Ë¥•: ' + d.error); }
                })
                .catch(function(e) { showToast('Â§±Ë¥•: ' + e.message); })
                .finally(function() {
                    btn.textContent = 'Ê∑ªÂä†Êí≠ÂÆ¢';
                    btn.disabled = false;
                });
        }
        
        function addFavorite(id) {
            fetch(API + '/favorite/' + id, {method: 'POST'}).then(function(r) { return r.json(); })
                .then(function(d) { if (d.success) showToast('Êî∂ËóèÊàêÂäüÔºÅ'); });
        }
        
        function deletePodcast(id) {
            showConfirm('ÂèñÊ∂àËÆ¢ÈòÖ', 'Á°ÆÂÆöÂèñÊ∂àËÆ¢ÈòÖËøô‰∏™Êí≠ÂÆ¢ÂêóÔºü', 'üóëÔ∏è', function(ok) {
                if (ok) {
                    fetch(API + '/podcast/' + id, {method: 'DELETE'})
                        .then(function(r) { return r.json(); })
                        .then(function(d) {
                            if (d.success) {
                                showToast('Â∑≤ÂèñÊ∂àËÆ¢ÈòÖ', '‚úÖ');
                                loadPodcasts();
                            }
                        });
                }
            });
        }
        
        function removeFavorite(id) {
            showConfirm('ÂèñÊ∂àÊî∂Ëóè', 'Á°ÆÂÆöÂèñÊ∂àÊî∂ËóèÂêóÔºü', 'üíî', function(ok) {
                if (ok) {
                    fetch(API + '/favorite/' + id, {method: 'DELETE'}).then(function(r) { return r.json(); })
                        .then(function(d) {
                            if (d.success) {
                                showToast('Â∑≤ÂèñÊ∂àÊî∂Ëóè', '‚úÖ');
                                loadFavorites();
                            }
                        });
                }
            });
        }
        
        function showEpisodes(podcastId) {
            var podcast = podcasts.find(function(p) { return p.id === podcastId; });
            if (!podcast) return;
            
            currentPodcastId = podcastId;
            
            document.getElementById('modal-title').textContent = podcast.title;
            document.getElementById('modal-author').textContent = podcast.author || '';
            document.getElementById('modal-count').textContent = podcast.episode_count + ' ÈõÜ';
            document.getElementById('modal-cover').src = podcast.image_url || '';
            
            document.getElementById('modal').classList.add('show');
            
            // ÂÖàÊòæÁ§∫ÁºìÂ≠òÔºåÂêéÂè∞Âà∑Êñ∞
            loadCachedEpisodes();
            refreshEpisodesInBackground();
        }
        
        function loadCachedEpisodes() {
            if (!currentPodcastId) return;
            fetch(API + '/podcast/' + currentPodcastId + '/episodes')
                .then(function(r) { return r.json(); })
                .then(function(d) {
                    renderEpisodes(d.data || []);
                });
        }
        
        function refreshEpisodes() {
            if (!currentPodcastId) {
                showToast('Êó†Ê≥ïÂà∑Êñ∞');
                return;
            }
            
            document.getElementById('modal-list').innerHTML = '<div class="loading">üîÑ Âà∑Êñ∞‰∏≠...</div>';
            
            fetch(API + '/podcast/' + currentPodcastId + '/refresh', { method: 'POST' })
                .then(function(r) { return r.json(); })
                .then(function(d) {
                    showToast('Â∑≤Âà∑Êñ∞ÔºÅ');
                    loadCachedEpisodes();
                    loadPodcasts();
                })
                .catch(function(e) {
                    showToast('Âà∑Êñ∞Â§±Ë¥•');
                    loadCachedEpisodes();
                });
        }
        
        function refreshEpisodesInBackground() {
            // ÂêéÂè∞ÈùôÈªòÂà∑Êñ∞ÂΩìÂâçÊí≠ÂÆ¢ËäÇÁõÆÂàóË°®
            if (!currentPodcastId) return;
            
            fetch(API + '/podcast/' + currentPodcastId + '/refresh', { 
                method: 'POST',
                cache: 'no-store'
            }).then(function(r) { return r.json(); })
              .then(function(d) {
                  // ÈùôÈªòÂÆåÊàêÔºå‰∏çÊòæÁ§∫ÊèêÁ§∫
                  loadCachedEpisodes();
              })
              .catch(function(e) {
                  console.log('ÂêéÂè∞Âà∑Êñ∞Â§±Ë¥•');
              });
        }
        
        function setSort(order) {
            sortOrder = order;
            document.getElementById('sort-new').classList.toggle('active', order === 'new');
            document.getElementById('sort-old').classList.toggle('active', order === 'old');
            renderEpisodes(currentEpisodes);
        }
        
        function renderEpisodes(list) {
            var container = document.getElementById('modal-list');
            if (!list || list.length === 0) {
                container.innerHTML = '<div class="empty">ÊöÇÊó†ËäÇÁõÆ</div>';
                return;
            }
            
            // API ËøîÂõûÂ∑≤ÊåâÊúÄÊñ∞ÊéíÂ∫èÔºåold Ê®°ÂºèÊâçÈúÄË¶Å reverse
            var sorted = list.slice();
            if (sortOrder === 'old') {
                sorted.reverse();
            }
            
            currentEpisodes = sorted;
            
            container.innerHTML = sorted.map(function(e, i) {
                var dur = e.duration_str || formatDuration(e.duration);
                var date = e.pub_date ? formatDate(e.pub_date) : '';
                var delay = (i * 0.05).toFixed(2);
                var playingClass = e.id === currentEpisodeId ? ' playing' : '';
                return '<div class="episode' + playingClass + '" onclick="playEpisode(' + i + ')" style="animation: listStagger 0.3s ease ' + delay + 's backwards;">' +
                    '<div class="episode-info"><div class="episode-title">' + e.title + '</div>' +
                    '<div class="episode-meta"><span class="episode-date">' + date + '</span><span>' + dur + '</span></div></div>' +
                    '<button class="queue-btn" onclick="event.stopPropagation();addToQueue(' + e.podcast_id + ',' + i + ')">+ÈòüÂàó</button></div>';
            }).join('');
        }
        
        function closeModal() {
            document.getElementById('modal').classList.remove('show');
        }
        
        function playEpisode(index) {
            // Áõ¥Êé•‰ΩøÁî® indexÔºåÂõ†‰∏∫ sorted Â∑≤ÁªèÊòØÊ≠£Á°ÆÈ°∫Â∫è
            var ep = currentEpisodes[index];
            if (!ep) return;
            
            var podcast = podcasts.find(function(p) { return p.id === ep.podcast_id; }) || {};
            
            currentEpisodeId = ep.id;
            
            document.getElementById('player').classList.add('show');
            document.getElementById('player-cover').src = podcast.image_url || '';
            document.getElementById('player-title').textContent = ep.title;
            document.getElementById('player-podcast').textContent = podcast.title || '';
            document.getElementById('player-duration').textContent = ep.duration_str || formatDuration(ep.duration);
            
            var audioUrl = typeof ep.audio_url === 'string' ? ep.audio_url.replace(/^\(|\)$/g, '').split(',')[0].replace(/['"]/g, '') : ep.audio_url;
            audioUrl = audioUrl.replace(/^\(|\)$/g, '');
            
            audio.src = audioUrl;
            audio.play();
            isPlaying = true;
            
            // ÂÖàÊõ¥Êñ∞Êí≠ÊîæÂàóË°®È´ò‰∫ÆÔºåÂÜçÂÖ≥Èó≠ modal
            var modalList = document.getElementById('modal-list');
            if (modalList) {
                var playingEpisodes = modalList.querySelectorAll('.episode');
                playingEpisodes.forEach(function(el, i) {
                    if (currentEpisodes[i] && currentEpisodes[i].id === currentEpisodeId) {
                        el.classList.add('playing');
                    } else {
                        el.classList.remove('playing');
                    }
                });
            }
            
            savePlayerState();
            closeModal();
            
            // Âä†ËΩΩ‰øùÂ≠òÁöÑËøõÂ∫¶
            if (ep.progress > 0) {
                fetch(API + '/progress/' + ep.id).then(function(r) { return r.json(); }).then(function(d) {
                    if (d.success && d.data.progress > 0) {
                        audio.currentTime = d.data.progress;
                        updatePlayerProgress();
                    }
                });
            }
        }
        
        function play(id) {
            fetch(API + '/play/' + id, {method: 'POST'}).then(function(r) { return r.json(); })
                .then(function(d) {
                    if (d.success) {
                        document.getElementById('player').classList.add('show');
                        document.getElementById('player-cover').src = d.image_url || '/static/cover.svg';
                        document.getElementById('player-title').textContent = d.title;
                        document.getElementById('player-podcast').textContent = d.podcast_title;
                        audio.src = d.audio_url;
                        audio.play();
                        isPlaying = true;
                        updatePlayButton();
                    }
                });
        }
        
        function togglePlay() {
            if (isPlaying) {
                audio.pause();
            } else {
                audio.play();
            }
            isPlaying = !isPlaying;
            updatePlayButton();
        }
        
        function updatePlayButton() {
            var icon = document.getElementById('play-icon');
            if (icon) {
                icon.textContent = isPlaying ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';
            }
            var btn = document.getElementById('play-btn');
            if (btn) {
                btn.style.transform = 'scale(1.1)';
                setTimeout(function() { btn.style.transform = 'scale(1)'; }, 150);
            }
        }
        
        function changeSpeed() {
            var speeds = [1, 1.25, 1.5, 2];
            var idx = speeds.indexOf(currentSpeed);
            var nextIdx = (idx + 1) % speeds.length;
            currentSpeed = speeds[nextIdx];
            audio.playbackRate = currentSpeed;
            var speedBtn = document.querySelector('.speed-btn');
            if (speedBtn) speedBtn.textContent = currentSpeed.toFixed(2) + 'x';
            showToast('Êí≠ÊîæÈÄüÂ∫¶: ' + currentSpeed.toFixed(2) + 'x', '‚ñ∂Ô∏è');
        }
        
        function addToQueue(podcastId, episodeIndex) {
            var podcast = podcasts.find(function(p) { return p.id === podcastId; });
            if (!podcast) {
                console.log('addToQueue: Podcast not found for id', podcastId);
                return;
            }
            
            console.log('addToQueue: Adding episode from podcast', podcast.title, 'episode index', episodeIndex);
            
            fetch(API + '/podcast/' + podcastId + '/episodes').then(function(r) { return r.json(); }).then(function(d) {
                var ep = d.data[episodeIndex];
                if (ep) {
                    // Êõ¥Êñ∞ÊâÄÊúâÈ°πÁõÆÁöÑ isPlaying Áä∂ÊÄÅ
                    for (var i = 0; i < playQueue.length; i++) {
                        playQueue[i].isPlaying = false;
                    }
                    // Ê∑ªÂä†Êñ∞È°πÁõÆ‰∏∫Ê≠£Âú®Êí≠Êîæ
                    playQueue.push({podcast: podcast, episode: ep, isPlaying: true});
                    queueIndex = playQueue.length - 1;
                    console.log('addToQueue: Added episode', ep.title, 'Queue length now:', playQueue.length, 'queueIndex:', queueIndex);
                    showToast('Â∑≤Ê∑ªÂä†Âà∞Êí≠ÊîæÈòüÂàó (' + playQueue.length + ')', 'üìã');
                    renderQueue();
                }
            });
        }
        
        function renderQueue() {
            var queueEl = document.getElementById('queue-list');
            var countEl = document.getElementById('queue-count');
            if (playQueue.length === 0) {
                queueEl.classList.remove('show');
                countEl.style.display = 'none';
                return;
            }
            
            countEl.style.display = 'inline';
            countEl.textContent = 'üìã ÈòüÂàó (' + playQueue.length + ')';
            
            queueEl.innerHTML = playQueue.map(function(item, idx) {
                var cls = idx === queueIndex ? 'queue-item playing' : 'queue-item';
                return '<div class="' + cls + '" onclick="playQueueItem(' + idx + ')">' +
                    '<img src="' + (item.podcast.image_url || '') + '" onerror="this.style.opacity=\'0.3\'" style="width:40px;height:40px;border-radius:6px;object-fit:cover;flex-shrink:0;">' +
                    '<div style="flex:1;min-width:0;"><div style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + item.episode.title + '</div>' +
                    '<div style="font-size:12px;opacity:0.7;display:flex;align-items:center;gap:6px;">' + 
                    '<span>' + item.podcast.title + '</span>' + 
                    (item.episode.duration_str ? '<span style="opacity:0.5;">' + item.episode.duration_str + '</span>' : '') + 
                    '</div></div>' +
                    '<button onclick="event.stopPropagation();removeFromQueue(' + idx + ')" style="background:none;border:none;color:#94a3b8;cursor:pointer;padding:4px;">‚úï</button></div>';
            }).join('');
        }
        
        // ========== Êí≠ÊîæÈòüÂàóÁÆ°ÁêÜ ==========
        
        // ÊãñÂä®ÊéíÂ∫èÁõ∏ÂÖ≥ÂèòÈáè
        var draggedItemIndex = null;
        
        function playQueueItem(idx) {
            if (idx >= playQueue.length) return;
            
            queueIndex = idx;
            
            // Êõ¥Êñ∞ÊâÄÊúâÈ°πÁõÆÁöÑ isPlaying Áä∂ÊÄÅ
            for (var i = 0; i < playQueue.length; i++) {
                playQueue[i].isPlaying = (i === idx);
            }
            
            var item = playQueue[idx];
            currentEpisodeId = item.episode.id;
            document.getElementById('player').classList.add('show');
            document.getElementById('player-cover').src = item.podcast.image_url || '';
            document.getElementById('player-title').textContent = item.episode.title;
            document.getElementById('player-podcast').textContent = item.podcast.title || '';
            audio.src = item.episode.audio_url;
            audio.play();
            isPlaying = true;
            renderQueue();
            
            // Â¶ÇÊûú popover ÊâìÂºÄÔºåÁ´ãÂç≥ÈáçÊñ∞Ê∏≤ÊüìÂàóË°®
            var popover = document.getElementById('queue-popover');
            if (popover && popover.classList.contains('show')) {
                renderQueueList();
            }
            savePlayerState();
        }
        
        function removeFromQueue(idx) {
            if (idx === queueIndex) {
                audio.pause();
            }
            playQueue.splice(idx, 1);
            // Êõ¥Êñ∞ isPlaying Áä∂ÊÄÅ
            if (queueIndex >= playQueue.length) {
                queueIndex = Math.max(0, playQueue.length - 1);
            }
            for (var i = 0; i < playQueue.length; i++) {
                playQueue[i].isPlaying = (i === queueIndex);
            }
            renderQueue();
            // Â¶ÇÊûú popover ÊâìÂºÄÔºåÊõ¥Êñ∞ÊòæÁ§∫
            var popover = document.getElementById('queue-popover');
            if (popover && popover.classList.contains('show')) {
                renderQueueList();
            }
            showToast('Â∑≤‰ªéÈòüÂàóÁßªÈô§', 'üìã');
        }
        
        // ÊãñÂä®ÂºÄÂßã
        function onQueueItemDragStart(event, idx) {
            draggedItemIndex = idx;
            event.target.style.opacity = '0.5';
            event.dataTransfer.effectAllowed = "move";
        }
        
        // ÊãñÂä®ÁªìÊùü
        function onQueueItemDragEnd(event) {
            event.target.classList.remove('dragging');
            event.target.style.opacity = '1';
            var items = document.querySelectorAll('.queue-popover-item');
            items.forEach(function(el) { el.classList.remove('drag-over'); });
            draggedItemIndex = null;
        }
        
        // ÊãñÂä®ÁªèËøáÔºàÂè™Ê∑ªÂä†ËßÜËßâÂèçÈ¶àÔºâ
        function onQueueItemDragOver(event, idx) {
            event.preventDefault();
            var items = document.querySelectorAll('.queue-popover-item');
            items.forEach(function(el) { el.classList.remove('drag-over'); });
            if (items[idx]) items[idx].classList.add('drag-over');
        }
        
        // ÊãñÂä®ÊîæÁΩÆÔºàÊâßË°å‰∫§Êç¢Ôºâ
        function onQueueItemDrop(event, idx) {
            event.preventDefault();
            if (draggedItemIndex === null || draggedItemIndex === idx) return;
            
            var draggedItem = playQueue[draggedItemIndex];
            var targetItem = playQueue[idx];
            playQueue[draggedItemIndex] = targetItem;
            playQueue[idx] = draggedItem;
            
            if (queueIndex === draggedItemIndex) {
                queueIndex = idx;
            } else if (queueIndex === idx) {
                queueIndex = draggedItemIndex;
            }
            
            for (var i = 0; i < playQueue.length; i++) {
                playQueue[i].isPlaying = (i === queueIndex);
            }
            
            renderQueueList();
            savePlayerState();
            showToast('Â∑≤Ë∞ÉÊï¥È°∫Â∫è', 'üìã');
        }
        
        function playNextInQueue() {
            if (queueIndex < playQueue.length - 1) {
                queueIndex++;
                playQueueItem(queueIndex);
            }
        }
        
        audio.addEventListener('ended', function() {
            if (playQueue.length > 0 && queueIndex < playQueue.length - 1) {
                playNextInQueue();
            } else {
                isPlaying = false;
                updatePlayButton();
            }
        });
        
        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            var isLight = document.body.classList.contains('light-theme');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
        }
        
        function updatePlayerProgress() {
            if (!audio || !audio.duration || isNaN(audio.duration)) return;
            var progress = (audio.currentTime / audio.duration) * 100;
            if (progress > 100) progress = 100;
            var bar = document.getElementById('player-progress-bar');
            var timeEl = document.getElementById('player-current-time');
            var durEl = document.getElementById('player-duration');
            if (bar) bar.style.width = progress + '%';
            if (timeEl) timeEl.textContent = formatDuration(Math.floor(audio.currentTime));
            if (durEl) durEl.textContent = formatDuration(Math.floor(audio.duration));
        }
        
        function seekPlayer(event) {
            if (!audio.duration) return;
            var progress = event.offsetX / event.target.offsetWidth;
            audio.currentTime = progress * audio.duration;
        }
        
        function saveProgress() {
            if (currentEpisodeId && audio.duration) {
                var progress = Math.floor(audio.currentTime);
                fetch(API + '/progress/' + currentEpisodeId, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({progress: progress})
                });
                savePlayerState();
            }
        }
        
        // ÊØè30Áßí‰øùÂ≠ò‰∏ÄÊ¨°ËøõÂ∫¶
        setInterval(saveProgress, 30000);
        
        function formatDuration(seconds) {
            if (!seconds) return '0:00';
            var h = Math.floor(seconds / 3600);
            var m = Math.floor((seconds % 3600) / 60);
            var s = seconds % 60;
            if (h > 0) return h + ':' + (m < 10 ? '0' : '') + m + ':' + (s < 10 ? '0' : '') + s;
            return m + ':' + (s < 10 ? '0' : '') + s;
        }
        
        function formatDate(isoString) {
            if (!isoString) return '';
            var date = new Date(isoString);
            var now = new Date();
            var diff = now - date;
            
            if (diff < 86400000) return date.toLocaleDateString('zh-CN', {month:'numeric', day:'numeric'});
            if (diff < 604800000) return Math.floor(diff / 86400000) + 'Â§©Ââç';
            return date.toLocaleDateString('zh-CN', {month:'long', day:'numeric'});
        }
        
        // ÂàùÂßãÂåñ‰∏ªÈ¢ò
        var savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            document.body.classList.add('light-theme');
        }
// ÊÅ¢Â§çÊí≠ÊîæËøõÂ∫¶
        restorePlayerState();
        
        loadPodcasts(false);  // ÂàùÂßãÂä†ËΩΩ‰∏çÂà∑Êñ∞ÔºåÂêéÂè∞ÈùôÈªòÂä†ËΩΩ
        
        // Èü≥È¢ë‰∫ã‰ª∂
        audio.addEventListener('timeupdate', function() {
            updatePlayerProgress();
        });
        
        audio.addEventListener('ended', function() {
            isPlaying = false;
            updatePlayButton();
        });
        
        // Ê∏≤ÊüìÊí≠ÊîæÂàóË°®ÔºàÂÆåÊï¥ÈáçÊñ∞Ê∏≤ÊüìÔºâ
        function renderQueueList() {
            var content = document.getElementById('queue-popover-content');
            if (!content || !playQueue || playQueue.length === 0) return;
            
            var html = '<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid rgba(56,189,248,0.2);background:rgba(15,23,42,0.95);">' +
                '<span style="font-size:13px;color:#38bdf8;font-weight:600;">Êí≠ÊîæÈòüÂàó (' + playQueue.length + ')</span>' +
                '<span style="font-size:11px;opacity:0.5;">ÈïøÊåâÊìç‰Ωú</span></div>';
            
            for (var k = 0; k < playQueue.length; k++) {
                var item = playQueue[k];
                var isPlaying = item.isPlaying;
                var playingClass = isPlaying ? ' queue-popover-item-playing' : '';
                var playingIcon = isPlaying ? '‚ñ∂ ' : '';
                html += '<div class="queue-popover-item' + playingClass + '" ' +
                    'onclick="playQueueItem(' + k + ')" ' +
                    'oncontextmenu="showQueueMenu(event, ' + k + '); return false;" ' +
                    'style="cursor:pointer;padding:12px 10px;">' +
                    '<img src="' + (item.podcast.image_url || '') + '" onerror="this.style.background=&quot;#334155&quot;;" style="width:36px;height:36px;border-radius:6px;object-fit:cover;">' +
                    '<div style="flex:1;min-width:0;margin-left:10px;overflow:hidden;">' +
                    '<div style="font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;' + (isPlaying ? 'color:#38bdf8;' : '') + '">' + playingIcon + item.episode.title + '</div>' +
                    '<div style="font-size:11px;opacity:0.6;margin-top:2px;">' + item.podcast.title + '</div></div>' +
                    '<span style="font-size:11px;opacity:0.5;white-space:nowrap;margin-left:6px;">' + (item.episode.duration_str || '0:00') + '</span></div>';
            }
            content.innerHTML = html;
        }
        
        // ÊòæÁ§∫ÈòüÂàóÊìç‰ΩúËèúÂçï
        var queueMenuTimer = null;
        var queueMenuEl = null;
        
        function showQueueMenu(event, idx) {
            event.preventDefault();
            var item = playQueue[idx];
            if (!item) return;
            
            // ÂàõÂª∫ËèúÂçï
            queueMenuEl = document.createElement('div');
            queueMenuEl.id = 'queue-menu';
            queueMenuEl.style.cssText = 'position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(15,23,42,0.98);border-radius:16px;padding:8px;min-width:200px;z-index:200;box-shadow:0 20px 40px rgba(0,0,0,0.5);border:1px solid rgba(56,189,248,0.3);';
            
            // ‰ΩøÁî® data Â±ûÊÄßÊù•Â≠òÂÇ® actionÔºåÈÅøÂÖçÂºïÂè∑ÈóÆÈ¢ò
            var html = '<div style="padding:8px 12px;font-size:13px;color:#94a3b8;border-bottom:1px solid rgba(56,189,248,0.2);margin-bottom:8px;">' + item.episode.title.substring(0, 20) + '</div>';
            html += '<div data-action="play" data-idx="' + idx + '" style="padding:12px 16px;cursor:pointer;display:flex;align-items:center;border-radius:8px;font-size:14px;color:#38bdf8;">‚ñ∂ Êí≠Êîæ</div>';
            html += '<div data-action="remove" data-idx="' + idx + '" style="padding:12px 16px;cursor:pointer;display:flex;align-items:center;border-radius:8px;font-size:14px;color:#ef4444;">‚úï ÁßªÈô§</div>';
            html += '<div id="queue-menu-cancel" style="padding:12px 16px;cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:8px;font-size:14px;opacity:0.6;margin-top:8px;">ÂèñÊ∂à</div>';
            
            queueMenuEl.innerHTML = html;
            document.body.appendChild(queueMenuEl);
            
            // ÁªëÂÆö‰∫ã‰ª∂
            queueMenuEl.querySelector('[data-action="play"]').addEventListener('click', function() {
                playQueueItem(idx);
                closeQueueMenu();
            });
            queueMenuEl.querySelector('[data-action="remove"]').addEventListener('click', function() {
                removeFromQueue(idx);
                closeQueueMenu();
            });
            document.getElementById('queue-menu-cancel').addEventListener('click', closeQueueMenu);
            
            // ÁÇπÂáªÂÖ∂‰ªñÂå∫ÂüüÂÖ≥Èó≠
            setTimeout(function() {
                document.addEventListener('click', closeQueueMenu);
            }, 0);
        }
        
        function closeQueueMenu() {
            if (queueMenuEl) {
                queueMenuEl.remove();
                queueMenuEl = null;
            }
            document.removeEventListener('click', closeQueueMenu);
        }
        
        function toggleQueuePopover() {
            var popover = document.getElementById('queue-popover');
            var content = document.getElementById('queue-popover-content');
            
            if (!playQueue || playQueue.length === 0) {
                showToast('ÈòüÂàó‰∏∫Á©∫');
                return;
            }
            
            // Ê∏≤ÊüìÈòüÂàóÈ°π
            renderQueueList();
            
            // ÂàáÊç¢ÊòæÁ§∫
            popover.classList.toggle('show');
            
            // ÁÇπÂáªÂ§ñÈÉ®ÈöêËóè
            if (popover.classList.contains('show')) {
                document.addEventListener('click', function hidePopover(e) {
                    if (!popover.contains(e.target) && !document.querySelector('.queue-icon').contains(e.target)) {
                        popover.classList.remove('show');
                        document.removeEventListener('click', hidePopover);
                    }
                });
            }
        }
        
        function savePlayerState() {
            try {
                var queueData = playQueue.map(function(item) {
                    return {
                        episode: {
                            id: item.episode.id,
                            title: item.episode.title,
                            audio_url: item.episode.audio_url,
                            duration_str: item.episode.duration_str
                        },
                        podcast: {
                            id: item.podcast.id,
                            title: item.podcast.title,
                            image_url: item.podcast.image_url
                        }
                    };
                });
                
                var state = {
                    currentTime: audio.currentTime || 0,
                    currentSpeed: currentSpeed,
                    queueData: queueData,
                    queueIndex: queueIndex
                };
                localStorage.setItem('playerState', JSON.stringify(state));
            } catch(e) {
                console.log('Save state error:', e);
            }
        }
        
        function restorePlayerState() {
            try {
                var saved = localStorage.getItem('playerState');
                if (saved) {
                    var state = JSON.parse(saved);
                    console.log('restorePlayerState: Found saved state', state);
                    if (state.queueData && state.queueData.length > 0) {
                        playQueue = state.queueData;
                        queueIndex = state.queueIndex || 0;
                        console.log('restorePlayerState: Restored queueIndex =', queueIndex, 'queue length =', playQueue.length);
                        
                        // ÊòæÁ§∫Êí≠ÊîæÊ†è
                        var player = document.getElementById('player');
                        var currentItem = playQueue[queueIndex];
                        
                        if (currentItem) {
                            player.classList.add('show');
                            document.getElementById('player-cover').src = currentItem.podcast.image_url || '/static/cover.svg';
                            document.getElementById('player-title').textContent = currentItem.episode.title;
                            document.getElementById('player-podcast').textContent = currentItem.podcast.title || '';
                            document.getElementById('player-duration').textContent = currentItem.episode.duration_str || '0:00';
                            currentEpisodeId = currentItem.episode.id;
                            
                            // ËÆæÁΩÆÈü≥È¢ë
                            if (currentItem.episode.audio_url) {
                                audio.src = currentItem.episode.audio_url;
                                if (state.currentTime > 0) {
                                    audio.currentTime = state.currentTime;
                                }
                            }
                            
                            // Ê∏≤ÊüìÈòüÂàó
                            renderQueue();
                            console.log('restorePlayerState: Completed restoring state');
                        }
                    }
                }
            } catch(e) {
                console.log('Restore state error:', e);
            }
        }
        
        audio.addEventListener('loadedmetadata', function() {
            
            document.getElementById('player-duration').textContent = formatDuration(audio.duration);
            updatePlayerProgress();
        });
        
        audio.addEventListener('play', function() {
            
            updatePlayButton();
            updatePlayerProgress();
        });
        
        audio.addEventListener('pause', function() {
            
            updatePlayButton();
        });
    </script>
    <div id="queue-popover" class="queue-popover">
        <div id="queue-popover-content"></div>
    </div>
</body>
</html>
