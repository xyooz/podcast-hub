<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Podcast Hub</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding-bottom: 100px;
            transition: background 0.3s, color 0.3s;
        }
        body.light-theme {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
            color: #1e293b;
        }
        body.light-theme .nav { background: rgba(248,250,252,0.95); }
        body.light-theme .nav-btn { background: rgba(255,255,255,0.5); border-color: rgba(0,0,0,0.1); color: #1e293b; }
        body.light-theme .card { background: rgba(255,255,255,0.8); color: #1e293b; }
        body.light-theme .modal-header { background: rgba(248,250,252,0.98); }
        body.light-theme .episode { background: rgba(255,255,255,0.7); color: #1e293b; }
        body.light-theme .add-box { background: rgba(248,250,252,0.8); }
        body.light-theme .input { background: rgba(255,255,255,0.9); border-color: rgba(0,0,0,0.2); color: #1e293b; }
        body.light-theme .btn-add { background: linear-gradient(135deg, #3b82f6, #8b5cf6); }
        body.light-theme .sort-btn { background: rgba(255,255,255,0.5); border-color: rgba(0,0,0,0.2); color: #1e293b; }
        body.light-theme .sort-btn.active { background: rgba(59,130,246,0.3); border-color: rgba(59,130,246,0.5); color: #1e293b; }
        body.light-theme .loading { color: #64748b; }
        body.light-theme .empty { color: #64748b; }
        body.light-theme .player { background: linear-gradient(90deg, #3b82f6, #8b5cf6, #c084fc); }
        body.light-theme .toast { background: rgba(248,250,252,0.95); color: #1e293b; }
        body.light-theme .player-btn, body.light-theme .speed-btn { background: rgba(255,255,255,0.3); }
        body.light-theme .player-progress { background: rgba(0,0,0,0.2); }
        body.light-theme .modal-btn.close { background: rgba(0,0,0,0.1); }
        body.light-theme .theme-btn { background: rgba(248,250,252,0.9); color: #1e293b; }
        .nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(30, 41, 59, 0.95);
            padding: 12px 16px;
            display: flex;
            gap: 8px;
            overflow-x: auto;
            z-index: 100;
        }
        .nav-btn {
            padding: 8px 12px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 12px;
            white-space: nowrap;
            cursor: pointer;
        }
        .nav-btn.active { background: rgba(56, 189, 248, 0.3); border-color: rgba(56, 189, 248, 0.5); }
        .nav-btn:active { background: rgba(255,255,255,0.2); }
        .main { padding: 80px 16px 20px; max-width: 600px; margin: 0 auto; }
        .add-box { background: rgba(30, 41, 59, 0.8); padding: 16px; border-radius: 12px; margin-bottom: 20px; }
        .add-box h2 { font-size: 16px; margin-bottom: 12px; }
        body.light-theme .add-box { background: rgba(248,250,252,0.8); }
        .search-result { padding: 8px; background: rgba(255,255,255,0.1); border-radius: 8px; margin-bottom: 8px; cursor: pointer; display: flex; align-items: center; gap: 12px; }
        .search-result:hover { background: rgba(255,255,255,0.2); }
        .search-result-img { width: 40px; height: 40px; border-radius: 6px; background: #334155; }
        .search-result-info { flex: 1; }
        .search-result-title { font-size: 14px; font-weight: 500; }
        .search-result-podcast { font-size: 12px; opacity: 0.7; }
        .input { width: 100%; padding: 12px; background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; font-size: 14px; margin-bottom: 10px; }
        .btn-add { width: 100%; padding: 12px; background: linear-gradient(135deg, #0ea5e9, #8b5cf6); border: none; border-radius: 8px; color: #fff; font-size: 14px; cursor: pointer; }
        .btn-add:active { opacity: 0.8; }
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .card { background: rgba(30, 41, 59, 0.7); border-radius: 12px; overflow: hidden; cursor: pointer; }
        .card-img { aspect-ratio: 1; position: relative; background: #334155; }
        .card-img img { width: 100%; height: 100%; object-fit: cover; }
        .card-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.6), transparent); }
        .card-info { position: absolute; bottom: 8px; left: 8px; right: 8px; }
        .card-title { font-size: 12px; font-weight: 600; }
        .card-count { font-size: 11px; opacity: 0.7; }
        .card-actions { display: flex; gap: 4px; padding: 8px; }
        .card-btn { flex: 1; padding: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: #fff; font-size: 12px; text-align: center; cursor: pointer; }
        .card-btn:active { background: rgba(255,255,255,0.2); }
        .tab { display: none; }
        .tab.active { display: block; }
        
        /* ÂºπÁ™ó */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200; }
        .modal.show { display: flex; flex-direction: column; }
        .modal-header { background: rgba(30, 41, 59, 0.98); padding: 12px 16px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .modal-cover { width: 56px; height: 56px; border-radius: 10px; background: #334155; flex-shrink: 0; }
        .modal-info { flex: 1; min-width: 150px; }
        .modal-title { font-size: 15px; font-weight: 600; }
        .modal-author { font-size: 12px; color: #94a3b8; margin-top: 2px; }
        .modal-count { font-size: 11px; color: #64748b; margin-top: 2px; }
        .modal-actions { display: flex; gap: 8px; margin-left: auto; }
        .modal-btn { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; }
        .modal-btn.refresh { background: rgba(56, 189, 248, 0.3); }
        .modal-btn.close { background: rgba(255,255,255,0.1); }
        
        /* ÊéíÂ∫èÂàáÊç¢ */
        .sort-bar { width: 100%; padding: 8px 0; display: flex; gap: 8px; justify-content: center; background: rgba(30, 41, 59, 0.5); }
        .sort-btn { padding: 6px 16px; border-radius: 16px; font-size: 12px; cursor: pointer; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #94a3b8; }
        .sort-btn.active { background: rgba(56, 189, 248, 0.3); border-color: rgba(56, 189, 248, 0.5); color: #fff; }
        .sort-btn:active { opacity: 0.8; }
        
        .modal-list { flex: 1; overflow-y: auto; padding: 8px; -webkit-overflow-scrolling: touch; max-height: calc(100vh - 200px); }
        .episode { background: rgba(30, 41, 59, 0.7); border-radius: 8px; padding: 12px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .episode:active { background: rgba(255,255,255,0.1); }
        .episode-info { flex: 1; min-width: 0; }
        .episode-title { font-size: 14px; font-weight: 500; }
        .episode-meta { font-size: 12px; color: #94a3b8; margin-top: 4px; display: flex; gap: 12px; }
        .episode-date { color: #64748b; }
        .episode-desc { font-size: 12px; color: #94a3b8; margin-top: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        body.light-theme .episode-desc { color: #64748b; }
        .queue-btn { padding: 4px 8px; font-size: 12px; background: rgba(255,255,255,0.1); border-radius: 4px; }
        .queue-list { padding: 8px 16px; background: rgba(0,0,0,0.3); }
        .queue-item { padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 12px; }
        .queue-item.playing { color: #38bdf8; }
        body.light-theme .queue-list { background: rgba(0,0,0,0.05); }
        body.light-theme .queue-item { border-color: rgba(0,0,0,0.1); }
        
        /* Êí≠ÊîæÂô® */
        .player { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: linear-gradient(90deg, #0ea5e9, #8b5cf6, #c084fc); padding: 12px 16px; z-index: 50; }
        .player.show { display: block; }
        .player-row { display: flex; align-items: center; gap: 12px; max-width: 600px; margin: 0 auto; }
        .player-cover { width: 48px; height: 48px; border-radius: 8px; background: #fff; }
        .player-info { flex: 1; min-width: 0; }
        .player-title { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .player-podcast { font-size: 12px; opacity: 0.7; }
        .player-btn { width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .player-progress { width: 100%; height: 4px; background: rgba(255,255,255,0.2); cursor: pointer; position: relative; margin-top: 8px; }
        .player-progress-bar { height: 100%; background: #38bdf8; transition: width 0.2s; }
        .player-time { font-size: 11px; color: rgba(255,255,255,0.7); margin-top: 4px; display: flex; justify-content: space-between; }
        .speed-btn { padding: 2px 8px; font-size: 10px; background: rgba(255,255,255,0.2); border-radius: 4px; }
        .theme-btn { position: fixed; top: 70px; right: 16px; width: 36px; height: 36px; background: rgba(30,41,59,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 150; font-size: 18px; }
        body.light-theme .theme-btn { background: rgba(248,250,252,0.9); }
        
        .loading { text-align: center; padding: 40px; color: #94a3b8; }
        .empty { text-align: center; padding: 60px 20px; color: #94a3b8; }
        .empty-icon { font-size: 48px; margin-bottom: 16px; }
        
        .toast {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 41, 59, 0.95);
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 300;
            display: none;
        }
        .toast.show { display: block; }
    </style>
</head>
<body>
    <nav class="nav">
        <button class="nav-btn active" onclick="showTab('discover')">ÂèëÁé∞</button>
        <button class="nav-btn" onclick="showTab('podcasts')">ËÆ¢ÈòÖ</button>
        <button class="nav-btn" onclick="showTab('favorites')">Êî∂Ëóè</button>
        <button class="nav-btn" onclick="showTab('history')">ÂéÜÂè≤</button>
        <button class="nav-btn" onclick="showTab('stats')">ÁªüËÆ°</button>
    </nav>
    
    <div id="tab-discover" class="tab active">
        <div class="main">
            <div class="add-box">
                <h2>Ê∑ªÂä†Êí≠ÂÆ¢</h2>
                <input type="text" id="add-url" class="input" placeholder="Á≤òË¥¥Â∞èÂÆáÂÆôÂàÜ‰∫´ÈìæÊé•ÊàñRSSÂú∞ÂùÄ...">
                <button class="btn-add" onclick="addPodcast()">Ê∑ªÂä†Êí≠ÂÆ¢</button>
            </div>
            
            <div class="add-box" style="padding:12px;">
                <input type="text" id="search-input" class="input" style="margin-bottom:8px;" placeholder="ÊêúÁ¥¢Êí≠ÂÆ¢ÂíåËäÇÁõÆ..." oninput="searchPodcasts(this.value)">
                <div id="search-results"></div>
            </div>
            <div id="podcasts-grid" class="grid"></div>
        </div>
    </div>
    
    <div id="tab-podcasts" class="tab">
        <div class="main"><div id="subscribed-grid" class="grid"></div></div>
    </div>
    <div id="tab-favorites" class="tab">
        <div class="main"><div id="favorites-grid" class="grid"></div></div>
    </div>
    <div id="tab-history" class="tab">
        <div class="main"><div id="history-list"></div></div>
    </div>
    <div id="tab-stats" class="tab">
        <div class="main" id="stats-content"></div>
    </div>
    
    <div id="modal" class="modal">
        <div class="modal-header">
            <img id="modal-cover" class="modal-cover" src="">
            <div class="modal-info">
                <div id="modal-title" class="modal-title"></div>
                <div id="modal-author" class="modal-author"></div>
                <div id="modal-count" class="modal-count"></div>
            </div>
            <div class="modal-actions">
                <div class="modal-btn refresh" onclick="refreshEpisodes()" title="Âà∑Êñ∞">üîÑ</div>
                <div class="modal-btn close" onclick="closeModal()">‚úï</div>
            </div>
        </div>
        <div class="sort-bar">
            <button class="sort-btn active" id="sort-new" onclick="setSort('new')">üîΩ ÊúÄÊñ∞</button>
            <button class="sort-btn" id="sort-old" onclick="setSort('old')">üîº ÊúÄÊóß</button>
        </div>
        <div id="modal-list" class="modal-list"></div>
    </div>
    
    <div id="player" class="player">
        <div class="player-row">
            <img id="player-cover" src="" class="player-cover">
            <div class="player-info">
                <div id="player-title" class="player-title"></div>
                <div id="player-podcast" class="player-podcast"></div>
                <div class="player-progress" onclick="seekPlayer(event)">
                    <div id="player-progress-bar" class="player-progress-bar" style="width:0%"></div>
                </div>
                <div class="player-time">
                    <span id="player-current-time">0:00</span>
                    <span id="player-duration">0:00</span>
                </div>
            </div>
            <div class="player-btn" onclick="togglePlay()">‚ñ∂Ô∏è</div>
            <div style="display:flex;align-items:center;gap:4px;">
                <button class="speed-btn" onclick="changeSpeed()">1x</button>
            </div>
        </div>
    </div>
    
    <audio id="audio"></audio>
    <div id="toast" class="toast"></div>
    <div class="theme-btn" onclick="toggleTheme()">üåô</div>
    
    <script>
        const API = '/api';
        let podcasts = [];
        let currentEpisodes = [];
        let currentPodcastId = null;
        let currentEpisodeId = null;
        let sortOrder = 'new'; // 'new' Êàñ 'old'
        let isPlaying = false;
        let progressTimer = null;
        let currentSpeed = 1;
        let playQueue = [];
        let queueIndex = 0;
        let audio = document.getElementById('audio');
        
        function showToast(msg) {
            var toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(function() { toast.classList.remove('show'); }, 2000);
        }
        
        function showTab(tab) {
            var btns = document.querySelectorAll('.nav-btn');
            btns.forEach(function(b) { b.classList.remove('active'); });
            btns[tab === 'discover' ? 0 : tab === 'podcasts' ? 1 : tab === 'favorites' ? 2 : 3].classList.add('active');
            
            document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
            document.getElementById('tab-' + tab).classList.add('active');
            
            if (tab === 'podcasts') {
                loadPodcasts(false);  // ÂÖàÊòæÁ§∫ÁºìÂ≠ò
                refreshInBackground();  // ÂêéÂè∞Âà∑Êñ∞
            }
            else if (tab === 'favorites') loadFavorites();
            else if (tab === 'history') loadHistory();
            else if (tab === 'stats') loadStats();
        }
        
        function searchPodcasts(keyword) {
            var results = document.getElementById('search-results');
            if (!keyword || keyword.length < 2) {
                results.innerHTML = "";
                return;
            }
            
            keyword = keyword.toLowerCase();
            var results_html = "";
            
            // ÊêúÁ¥¢Êí≠ÂÆ¢
            podcasts.forEach(function(p) {
                if (p.title.toLowerCase().includes(keyword)) {
                    results_html += "<div class=\"search-result\" onclick=\"showEpisodes(" + p.id + ")\">" +
                        "<img src=\"" + (p.image_url || "") + "\" class=\"search-result-img\" onerror=\"this.style.background='#334155'\">" +
                        "<div class=\"search-result-info\"><div class=\"search-result-title\">" + p.title + "</div>" +
                        "<div class=\"search-result-podcast\">Êí≠ÂÆ¢ ¬∑ " + p.episode_count + " ÈõÜ</div></div></div>";
                }
            });
            
            // ÊêúÁ¥¢ËäÇÁõÆ
            currentEpisodes.forEach(function(e) {
                if (e.title.toLowerCase().includes(keyword)) {
                    var podcast = podcasts.find(function(p) { return p.id === e.podcast_id; }) || {};
                    results_html += "<div class=\"search-result\" onclick=\"playSearchedEpisode(" + e.podcast_id + "," + e.id + ")\">" +
                        "<img src=\"" + (podcast.image_url || "") + "\" class=\"search-result-img\" onerror=\"this.style.background='#334155'\">" +
                        "<div class=\"search-result-info\"><div class=\"search-result-title\">" + e.title + "</div>" +
                        "<div class=\"search-result-podcast\">" + (podcast.title || "") + " ¬∑ " + (e.duration_str || "0:00") + "</div></div></div>";
                }
            });
            
            results.innerHTML = results_html || "<div style=\"padding:8px;color:#64748b;font-size:12px;\">Êú™ÊâæÂà∞ÁªìÊûú</div>";
        }
        
        function playSearchedEpisode(podcastId, episodeId) {
            fetch(API + '/podcast/' + podcastId + '/episodes').then(function(r) { return r.json(); }).then(function(d) {
                var ep = d.data.find(function(e) { return e.id === episodeId; });
                if (ep) {
                    var podcast = podcasts.find(function(p) { return p.id === podcastId; }) || {};
                    document.getElementById('player').classList.add('show');
                    document.getElementById('player-cover').src = podcast.image_url || '';
                    document.getElementById('player-title').textContent = ep.title;
                    document.getElementById('player-podcast').textContent = podcast.title || '';
                    currentEpisodeId = ep.id;
                    audio.src = ep.audio_url;
                    audio.play();
                    isPlaying = true;
                    document.getElementById('search-input').value = '';
                    document.getElementById('search-results').innerHTML = '';
                }
            });
        }
        
        function loadPodcasts(refresh) {
            var grid = document.getElementById('podcasts-grid');
            if (refresh) {
                // Âà∑Êñ∞Ê®°ÂºèÔºöÊòæÁ§∫Âä†ËΩΩ‰∏≠
                grid.innerHTML = '<div class="loading">üîÑ Âà∑Êñ∞‰∏≠...</div>';
            } else {
                // Âä†ËΩΩÊ®°ÂºèÔºöÂø´ÈÄüÊòæÁ§∫
                grid.innerHTML = '<div class="loading">Âä†ËΩΩ‰∏≠...</div>';
            }
            
            fetch(API + '/podcast').then(function(r) { return r.json(); }).then(function(d) {
                if (d.success) {
                    podcasts = d.data;
                    renderPodcasts(podcasts, 'podcasts-grid');
                    renderPodcasts(podcasts, 'subscribed-grid');
                }
            });
        }
        
        function refreshInBackground() {
            // ÂêéÂè∞ÈùôÈªòÂà∑Êñ∞ÊâÄÊúâÊí≠ÂÆ¢
            fetch(API + '/podcast').then(function(r) { return r.json(); }).then(function(d) {
                if (d.success && d.data) {
                    d.data.forEach(function(p) {
                        fetch(API + '/podcast/' + p.id + '/refresh', { 
                            method: 'POST',
                            cache: 'no-store'
                        }).catch(function(e) {
                            console.log('ÂêéÂè∞Âà∑Êñ∞Â§±Ë¥•: ' + p.title);
                        });
                    });
                }
            });
        }
        
        
        function renderPodcasts(list, containerId) {
            var container = document.getElementById(containerId);
            if (!container) return;
            if (list.length === 0) {
                container.innerHTML = '<div class="empty"><div class="empty-icon">üì≠</div><p>ÊöÇÊó†ÂÜÖÂÆπ</p></div>';
                return;
            }
            
            var isSubscribed = containerId === 'subscribed-grid';
            var isFavorites = containerId === 'favorites-grid';
            
            container.innerHTML = list.map(function(p) {
                var img = p.image_url || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><rect fill="%23334155" width="200" height="200"/><text x="100" y="100" text-anchor="middle" fill="%2394a3b8" font-size="60">üéôÔ∏è</text></svg>';
                var actions = '';
                if (isSubscribed) {
                    actions = '<div class="card-actions"><button class="card-btn" onclick="event.stopPropagation();deletePodcast(' + p.id + ')">üóëÔ∏è</button><button class="card-btn" onclick="event.stopPropagation();addFavorite(' + p.id + ')">‚ù§Ô∏è</button></div>';
                } else if (isFavorites) {
                    actions = '<div class="card-actions"><button class="card-btn" onclick="event.stopPropagation();removeFavorite(' + p.id + ')">üíî</button></div>';
                } else {
                    actions = '<div class="card-actions"><button class="card-btn" onclick="event.stopPropagation();addFavorite(' + p.id + ')">‚ù§Ô∏è</button></div>';
                }
                return '<div class="card" onclick="showEpisodes(' + p.id + ')"><div class="card-img"><img src="' + img + '"><div class="card-overlay"></div><div class="card-info"><div class="card-title">' + p.title + '</div><div class="card-count">' + p.episode_count + ' ÈõÜ</div></div></div>' + actions + '</div>';
            }).join('');
        }

        function loadFavorites() {
            fetch(API + '/favorite').then(function(r) { return r.json(); }).then(function(d) {
                if (d.success) renderPodcasts(d.data, 'favorites-grid');
            });
        }
        
        function loadStats() {
            var container = document.getElementById('stats-content');
            container.innerHTML = '<div class="loading">Âä†ËΩΩ‰∏≠...</div>';
            
            fetch(API + '/stats').then(function(r) { return r.json(); }).then(function(d) {
                if (d.success) {
                    var s = d.data;
                    container.innerHTML = '<div class="add-box">' +
                        '<h2>Êí≠ÊîæÁªüËÆ°</h2>' +
                        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px;">' +
                        '<div style="text-align:center;padding:16px;background:rgba(255,255,255,0.1);border-radius:8px;">' +
                        '<div style="font-size:24px;font-weight:bold;">' + s.total_plays + '</div>' +
                        '<div style="font-size:12px;opacity:0.7;">Êí≠ÊîæÊ¨°Êï∞</div></div>' +
                        '<div style="text-align:center;padding:16px;background:rgba(255,255,255,0.1);border-radius:8px;">' +
                        '<div style="font-size:24px;font-weight:bold;">' + s.total_duration_str + '</div>' +
                        '<div style="font-size:12px;opacity:0.7;">ÊÄªÊó∂Èïø</div></div></div>' +
                        '<h3 style="margin:20px 0 12px;font-size:14px;">ÁÉ≠Èó®Êí≠ÂÆ¢</h3>' +
                        (s.podcasts.map(function(p) {
                            return '<div style="padding:12px;background:rgba(255,255,255,0.1);border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">' +
                                '<span>' + p.title + '</span>' +
                                '<span style="opacity:0.7;">' + p.count + ' Ê¨°</span></div>';
                        }).join('')) +
                        '</div>';
                } else {
                    container.innerHTML = '<div class="empty">Âä†ËΩΩÂ§±Ë¥•</div>';
                }
            });
        }
        
        function loadHistory() {
            var container = document.getElementById('history-list');
            fetch(API + '/history').then(function(r) { return r.json(); }).then(function(d) {
                if (d.data.length === 0) {
                    container.innerHTML = '<div class="empty"><div class="empty-icon">üïê</div><p>ÊöÇÊó†ËÆ∞ÂΩï</p></div>';
                    return;
                }
                container.innerHTML = d.data.map(function(h) {
                    return '<div class="card" style="margin-bottom:12px;padding:12px;display:flex;align-items:center;gap:12px;cursor:pointer;" onclick="play(' + h.episode_id + ')">' +
                        '<img src="' + (getPodcastImage(h.podcast_id) || '') + '" style="width:48px;height:48px;border-radius:8px;background:#334155;">' +
                        '<div style="flex:1;min-width:0;"><div style="font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + h.title + '</div>' +
                        '<div style="font-size:12px;color:#94a3b8;">' + h.podcast_title + '</div></div></div>';
                }).join('');
            });
        }
        
        function getPodcastImage(id) {
            var p = podcasts.find(function(x) { return x.id === id; });
            return p ? p.image_url : null;
        }
        
        function addPodcast() {
            var url = document.getElementById('add-url').value.trim();
            if (!url) { showToast('ËØ∑ËæìÂÖ•ÈìæÊé•'); return; }
            
            var btn = document.querySelector('.btn-add');
            btn.textContent = 'Ê∑ªÂä†‰∏≠...';
            btn.disabled = true;
            
            fetch(API + '/podcast', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({url: url}) })
                .then(function(r) { return r.json(); })
                .then(function(d) {
                    if (d.success) {
                        showToast('Ê∑ªÂä†ÊàêÂäüÔºÅ');
                        document.getElementById('add-url').value = '';
                        loadPodcasts();
                    } else { showToast('Â§±Ë¥•: ' + d.error); }
                })
                .catch(function(e) { showToast('Â§±Ë¥•: ' + e.message); })
                .finally(function() {
                    btn.textContent = 'Ê∑ªÂä†Êí≠ÂÆ¢';
                    btn.disabled = false;
                });
        }
        
        function addFavorite(id) {
            fetch(API + '/favorite/' + id, {method: 'POST'}).then(function(r) { return r.json(); })
                .then(function(d) { if (d.success) showToast('Êî∂ËóèÊàêÂäüÔºÅ'); });
        }
        
        function deletePodcast(id) {
            if (!confirm('Á°ÆÂÆöÂèñÊ∂àËÆ¢ÈòÖËøô‰∏™Êí≠ÂÆ¢ÂêóÔºü')) return;
            fetch(API + '/podcast/' + id, {method: 'DELETE'})
                .then(function(r) { return r.json(); })
                .then(function(d) {
                    if (d.success) {
                        showToast('Â∑≤ÂèñÊ∂àËÆ¢ÈòÖ');
                        loadPodcasts();
                    }
                });
        }
        
        function removeFavorite(id) {
            if (!confirm('Á°ÆÂÆöÂèñÊ∂àÊî∂ËóèÂêóÔºü')) return;
            fetch(API + '/favorite/' + id, {method: 'DELETE'}).then(function(r) { return r.json(); })
                .then(function(d) {
                    if (d.success) {
                        showToast('Â∑≤ÂèñÊ∂àÊî∂Ëóè');
                        loadFavorites();
                    }
                });
        }
        
        function showEpisodes(podcastId) {
            var podcast = podcasts.find(function(p) { return p.id === podcastId; });
            if (!podcast) return;
            
            currentPodcastId = podcastId;
            
            document.getElementById('modal-title').textContent = podcast.title;
            document.getElementById('modal-author').textContent = podcast.author || '';
            document.getElementById('modal-count').textContent = podcast.episode_count + ' ÈõÜ';
            document.getElementById('modal-cover').src = podcast.image_url || '';
            
            document.getElementById('modal').classList.add('show');
            
            // ÂÖàÊòæÁ§∫ÁºìÂ≠òÔºåÂêéÂè∞Âà∑Êñ∞
            loadCachedEpisodes();
            refreshEpisodesInBackground();
        }
        
        function loadCachedEpisodes() {
            if (!currentPodcastId) return;
            fetch(API + '/podcast/' + currentPodcastId + '/episodes')
                .then(function(r) { return r.json(); })
                .then(function(d) {
                    renderEpisodes(d.data || []);
                });
        }
        
        function refreshEpisodes() {
            if (!currentPodcastId) {
                showToast('Êó†Ê≥ïÂà∑Êñ∞');
                return;
            }
            
            document.getElementById('modal-list').innerHTML = '<div class="loading">üîÑ Âà∑Êñ∞‰∏≠...</div>';
            
            fetch(API + '/podcast/' + currentPodcastId + '/refresh', { method: 'POST' })
                .then(function(r) { return r.json(); })
                .then(function(d) {
                    showToast('Â∑≤Âà∑Êñ∞ÔºÅ');
                    loadCachedEpisodes();
                    loadPodcasts();
                })
                .catch(function(e) {
                    showToast('Âà∑Êñ∞Â§±Ë¥•');
                    loadCachedEpisodes();
                });
        }
        
        function refreshEpisodesInBackground() {
            // ÂêéÂè∞ÈùôÈªòÂà∑Êñ∞ÂΩìÂâçÊí≠ÂÆ¢ËäÇÁõÆÂàóË°®
            if (!currentPodcastId) return;
            
            fetch(API + '/podcast/' + currentPodcastId + '/refresh', { 
                method: 'POST',
                cache: 'no-store'
            }).then(function(r) { return r.json(); })
              .then(function(d) {
                  // ÈùôÈªòÂÆåÊàêÔºå‰∏çÊòæÁ§∫ÊèêÁ§∫
                  loadCachedEpisodes();
              })
              .catch(function(e) {
                  console.log('ÂêéÂè∞Âà∑Êñ∞Â§±Ë¥•');
              });
        }
        
        function setSort(order) {
            sortOrder = order;
            document.getElementById('sort-new').classList.toggle('active', order === 'new');
            document.getElementById('sort-old').classList.toggle('active', order === 'old');
            renderEpisodes(currentEpisodes);
        }
        
        function renderEpisodes(list) {
            var container = document.getElementById('modal-list');
            if (!list || list.length === 0) {
                container.innerHTML = '<div class="empty">ÊöÇÊó†ËäÇÁõÆ</div>';
                return;
            }
            
            // ÊéíÂ∫è
            var sorted = list.slice();
            if (sortOrder === 'new') {
                sorted.reverse();
            }
            
            currentEpisodes = sorted;
            
            container.innerHTML = sorted.map(function(e, i) {
                var dur = e.duration_str || formatDuration(e.duration);
                var date = e.pub_date ? formatDate(e.pub_date) : '';
                var idx = sortOrder === 'new' ? (sorted.length - 1 - i) : i;
                return '<div class="episode" onclick="playEpisode(' + idx + ')">' +
                    '<div class="episode-info"><div class="episode-title">' + e.title + '</div>' +
                    '<div class="episode-meta"><span class="episode-date">' + date + '</span><span>' + dur + '</span></div></div>' +
                    '<button class="queue-btn" onclick="event.stopPropagation();addToQueue(' + e.podcast_id + ',' + idx + ')">+ÈòüÂàó</button></div>';
            }).join('');
        }
        
        function closeModal() {
            document.getElementById('modal').classList.remove('show');
        }
        
        function playEpisode(sortedIndex) {
            // ËÆ°ÁÆóÂÆûÈôÖÁ¥¢Âºï
            var index = sortOrder === 'new' ? (currentEpisodes.length - 1 - sortedIndex) : sortedIndex;
            var ep = currentEpisodes[index];
            if (!ep) return;
            
            var podcast = podcasts.find(function(p) { return p.id === ep.podcast_id; }) || {};
            
            currentEpisodeId = ep.id;
            
            document.getElementById('player').classList.add('show');
            document.getElementById('player-cover').src = podcast.image_url || '';
            document.getElementById('player-title').textContent = ep.title;
            document.getElementById('player-podcast').textContent = podcast.title || '';
            
            var audioUrl = typeof ep.audio_url === 'string' ? ep.audio_url.replace(/^\(|\)$/g, '').split(',')[0].replace(/['"]/g, '') : ep.audio_url;
            audioUrl = audioUrl.replace(/^\(|\)$/g, '');
            
            audio.src = audioUrl;
            audio.play();
            isPlaying = true;
            closeModal();
            savePlayerState();
            
            // Âä†ËΩΩ‰øùÂ≠òÁöÑËøõÂ∫¶
            if (ep.progress > 0) {
                fetch(API + '/progress/' + ep.id).then(function(r) { return r.json(); }).then(function(d) {
                    if (d.success && d.data.progress > 0) {
                        audio.currentTime = d.data.progress;
                        updatePlayerProgress();
                    }
                });
            }
        }
        
        function play(id) {
            fetch(API + '/play/' + id, {method: 'POST'}).then(function(r) { return r.json(); })
                .then(function(d) {
                    if (d.success) {
                        document.getElementById('player').classList.add('show');
                        document.getElementById('player-cover').src = d.image_url || '';
                        document.getElementById('player-title').textContent = d.title;
                        document.getElementById('player-podcast').textContent = d.podcast_title;
                        audio.src = d.audio_url;
                        audio.play();
                        isPlaying = true;
                    }
                });
        }
        
        function togglePlay() {
            if (isPlaying) {
                audio.pause();
            } else {
                audio.play();
            }
            isPlaying = !isPlaying;
        }
        
        function changeSpeed() {
            var speeds = [1, 1.25, 1.5, 2];
            var idx = speeds.indexOf(currentSpeed);
            currentSpeed = speeds[(idx + 1) % speeds.length];
            audio.playbackRate = currentSpeed;
            showToast('Êí≠ÊîæÈÄüÂ∫¶: ' + currentSpeed + 'x');
        }
        
        function addToQueue(podcastId, episodeIndex) {
            var podcast = podcasts.find(function(p) { return p.id === podcastId; });
            if (!podcast) return;
            
            fetch(API + '/podcast/' + podcastId + '/episodes').then(function(r) { return r.json(); }).then(function(d) {
                var ep = d.data[episodeIndex];
                if (ep) {
                    playQueue.push({podcast: podcast, episode: ep});
                    showToast('Â∑≤Ê∑ªÂä†Âà∞Êí≠ÊîæÈòüÂàó (' + playQueue.length + ')');
                    renderQueue();
                }
            });
        }
        
        function renderQueue() {
            var queueEl = document.getElementById('queue-list');
            var countEl = document.getElementById('queue-count');
            if (playQueue.length === 0) {
                queueEl.style.display = 'none';
                countEl.style.display = 'none';
                return;
            }
            
            countEl.style.display = 'inline';
            countEl.textContent = 'üìã ÈòüÂàó (' + playQueue.length + ')';
            queueEl.style.display = 'none';  // ÈªòËÆ§ÈöêËóèÔºåÁÇπÂáªÊâçÊòæÁ§∫
            
            queueEl.innerHTML = playQueue.map(function(item, idx) {
                var cls = idx === queueIndex ? 'queue-item playing' : 'queue-item';
                return '<div class="' + cls + '" onclick="playQueueItem(' + idx + ')">' +
                    '<span>' + (idx + 1) + '.</span>' +
                    '<div style="flex:1;"><div>' + item.episode.title + '</div>' +
                    '<div style="font-size:12px;opacity:0.7;">' + item.podcast.title + '</div></div>' +
                    '<span style="font-size:12px;">' + (item.episode.duration_str || '0:00') + '</span></div>';
            }).join('');
        }
        
        function playQueueItem(idx) {
            if (idx >= playQueue.length) return;
            queueIndex = idx;
            var item = playQueue[idx];
            currentEpisodeId = item.episode.id;
            document.getElementById('player').classList.add('show');
            document.getElementById('player-cover').src = item.podcast.image_url || '';
            document.getElementById('player-title').textContent = item.episode.title;
            document.getElementById('player-podcast').textContent = item.podcast.title || '';
            audio.src = item.episode.audio_url;
            audio.play();
            isPlaying = true;
            renderQueue();
        }
        
        function playNextInQueue() {
            if (queueIndex < playQueue.length - 1) {
                queueIndex++;
                playQueueItem(queueIndex);
            }
        }
        
        audio.addEventListener('ended', function() {
            if (playQueue.length > 0 && queueIndex < playQueue.length - 1) {
                playNextInQueue();
            } else {
                isPlaying = false;
            }
        });
        
        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            var isLight = document.body.classList.contains('light-theme');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
        }
        
        function updatePlayerProgress() {
            if (!audio.duration) return;
            var progress = (audio.currentTime / audio.duration) * 100;
            document.getElementById('player-progress-bar').style.width = progress + '%';
            document.getElementById('player-current-time').textContent = formatDuration(Math.floor(audio.currentTime));
        }
        
        function seekPlayer(event) {
            if (!audio.duration) return;
            var progress = event.offsetX / event.target.offsetWidth;
            audio.currentTime = progress * audio.duration;
        }
        
        function saveProgress() {
            if (currentEpisodeId && audio.duration) {
                var progress = Math.floor(audio.currentTime);
                fetch(API + '/progress/' + currentEpisodeId, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({progress: progress})
                });
                savePlayerState();
            }
        }
        
        // ÊØè30Áßí‰øùÂ≠ò‰∏ÄÊ¨°ËøõÂ∫¶
        setInterval(saveProgress, 30000);
        
        function formatDuration(seconds) {
            if (!seconds) return '0:00';
            var h = Math.floor(seconds / 3600);
            var m = Math.floor((seconds % 3600) / 60);
            var s = seconds % 60;
            if (h > 0) return h + ':' + (m < 10 ? '0' : '') + m + ':' + (s < 10 ? '0' : '') + s;
            return m + ':' + (s < 10 ? '0' : '') + s;
        }
        
        function formatDate(isoString) {
            if (!isoString) return '';
            var date = new Date(isoString);
            var now = new Date();
            var diff = now - date;
            
            if (diff < 86400000) return date.toLocaleDateString('zh-CN', {month:'numeric', day:'numeric'});
            if (diff < 604800000) return Math.floor(diff / 86400000) + 'Â§©Ââç';
            return date.toLocaleDateString('zh-CN', {month:'long', day:'numeric'});
        }
        
        // ÂàùÂßãÂåñ‰∏ªÈ¢ò
        var savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            document.body.classList.add('light-theme');
        }
// ÊÅ¢Â§çÊí≠ÊîæËøõÂ∫¶
        restorePlayerState();
        
        loadPodcasts(false);  // ÂàùÂßãÂä†ËΩΩ‰∏çÂà∑Êñ∞ÔºåÂêéÂè∞ÈùôÈªòÂä†ËΩΩ
        
        // Èü≥È¢ë‰∫ã‰ª∂
        audio.addEventListener('timeupdate', function() {
            updatePlayerProgress();
        });
        
        audio.addEventListener('ended', function() {
            isPlaying = false;
        });
        
        function toggleQueue() {
            var queueEl = document.getElementById('queue-list');
            var countEl = document.getElementById('queue-count');
            if (queueEl.style.display === 'none') {
                queueEl.style.display = 'block';
                countEl.textContent = 'üìã ÈòüÂàó (' + playQueue.length + ')';
            } else {
                queueEl.style.display = 'none';
                countEl.textContent = 'üìã ÈòüÂàó';
            }
        }
        
        audio.addEventListener('loadedmetadata', function() {
            document.getElementById('player-duration').textContent = formatDuration(audio.duration);
        });
    </script>
</body>
</html>
